<!DOCTYPE html><html><head>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
</head><body>
  <table id="review"><thead>
    <tr><th>Select</th><th>Prodotto</th><th>Campo</th><th>Old</th><th>New</th></tr>
  </thead><tbody></tbody></table>
  <button id="confirm">Conferma</button>
  <script>
    async function load() {
      const params = new URLSearchParams(location.search);
      const import_id = params.get('import_id');
      const diffs = await fetch(`/api/compute-diffs`, {
        method:'POST', body: JSON.stringify({ import_id })
      }).then(r=>r.json());
      $('#review').DataTable({
        data: diffs.map(d=>[`<input type="checkbox" data-index="${d.productId}">`, d.title, d.field, d.oldValue, d.newValue])
      });
      $('#confirm').click(async()=>{
        const updates = diffs.filter((_,i)=> $('input[data-index]').eq(i).is(':checked'));
        await fetch('/api/apply-updates', { method:'POST', body: JSON.stringify({ import_id, updates })});
        alert('Aggiornamenti inviati');
      });
    }
    load();
  </script>
</body></html>
