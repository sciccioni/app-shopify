<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Sincronizzazione e Verifica Dati</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .drop-zone.drag-over {
            background-color: #e2e8f0;
            border-color: #94a3b8;
        }
        .status-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        .error-box {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-button.active {
            color: #4f46e5; /* indigo-600 */
            border-bottom-color: #4f46e5;
            font-weight: 600;
        }
        .sub-tab-button {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #6b7280; /* gray-500 */
        }
        .sub-tab-button.active {
            color: #4f46e5; /* indigo-600 */
            border-bottom-color: #4f46e5;
            font-weight: 600;
        }
        .debug-cell {
            background-color: #fefce8;
            font-family: monospace;
            font-size: 10px;
            white-space: pre;
            max-width: 400px;
            overflow-x: auto;
        }
        /* Aggiungi questo per nascondere la colonna di debug */
        /* Per la produzione, puoi nascondere la colonna di DEBUG */
        /*
        #sync-report-table-head th:last-child,
        #sync-report-table-body td:last-child {
             display: none;
        }
        */
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="password-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-center">Accesso Richiesto APP Giacenze</h2>
            <p class="text-center text-gray-600 mb-6">Inserisci la password per continuare.</p>
            <div class="space-y-4">
                <div>
                    <label for="password-input" class="sr-only">Password</label>
                    <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Password">
                </div>
                <button id="login-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Accedi</button>
            </div>
            <p id="password-error" class="text-red-500 text-sm text-center mt-4 hidden">Password non corretta. Riprova.</p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <header class="mb-4">
                <h1 class="text-3xl font-bold text-gray-900">App Sincronizzazione e Verifica</h1>
                <p class="text-gray-600 mt-1">Usa le schede qui sotto per sincronizzare i dati con Shopify o per verificare il contenuto di un file.</p>
            </header>

            <div class="border-b border-gray-200 mb-6">
                <nav class="flex -mb-px">
                    <button id="sync-tab-button" class="tab-button active">Sincronizzazione</button>
                    <button id="verify-tab-button" class="tab-button">Verifica File</button>
                </nav>
            </div>

            <div id="sync-tab-content">
                <main class="space-y-8">
                    <div id="error-message-box" class="error-box p-4 rounded-md hidden" role="alert">
                       <p id="error-message-text" class="text-sm"></p>
                    </div>
    
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4">1. Carica File</h2>
                        <div id="drop-zone" class="drop-zone p-8 text-center rounded-lg cursor-pointer">
                            <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 16v-4a4 4 0 00-4-4H8a4 4 0 00-4 4v4m16 0l-3-3m-13 3l3-3"></path></svg>
                                <p class="text-gray-600">Trascina qui il file o <span class="font-semibold text-indigo-600">clicca per selezionarlo</span>.</p>
                                <p id="file-name" class="text-sm text-gray-500 mt-2"></p>
                            </div>
                        </div>
                        <button id="analyze-button" class="mt-4 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed transition-colors" disabled>
                            Analizza File
                        </button>
                    </div>

                    <div id="loader" class="text-center p-8 hidden">
                        <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p id="loader-text" class="mt-2 text-gray-600">Elaborazione in corso...</p>
                    </div>
    
                    <div id="results-section" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hidden">
                        <div class="border-b border-gray-200 mb-4">
                            <nav class="flex -mb-px">
                                <button id="raw-import-tab-button" class="sub-tab-button">Dati Importati (Raw)</button>
                                <button id="sync-report-tab-button" class="sub-tab-button active">Report di Sincronizzazione</button>
                            </nav>
                        </div>

                        <div id="raw-import-content" class="hidden">
                            <h2 class="text-xl font-semibold mb-4">Dati Importati (Raw)</h2>
                            <div id="raw-import-table-container" class="mt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <input type="search" id="raw-search-input" class="w-1/3 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Cerca nei dati importati...">
                                    <button id="download-raw-csv-button" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 text-sm">
                                        Scarica Raw Report
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead id="raw-import-table-head" class="bg-gray-50"></thead>
                                        <tbody id="raw-import-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                                <div id="raw-pagination-controls" class="mt-4 flex items-center justify-between">
                                    <button id="raw-prev-page-button" class="bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:bg-gray-200 disabled:cursor-not-allowed">&larr; Precedente</button>
                                    <span id="raw-page-indicator" class="text-sm font-semibold"></span>
                                    <button id="raw-next-page-button" class="bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:bg-gray-200 disabled:cursor-not-allowed">Successivo &rarr;</button>
                                </div>
                            </div>
                        </div>

                        <div id="sync-report-content">
                            <h2 class="text-xl font-semibold mb-4">Report di Sincronizzazione Shopify</h2>
                            <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-4 hidden">
                                <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div id="summary" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6"></div>
                            
                            <div id="sync-action-area" class="mt-6 p-4 border-t border-b border-gray-200 hidden">
                                <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                                    <div class="flex items-center">
                                        <input id="confirm-sync-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                        <label for="confirm-sync-checkbox" class="ml-2 block text-sm text-gray-900">
                                            Confermo di voler aggiornare i prodotti selezionati.
                                        </label>
                                    </div>
                                    <button id="sync-button" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed transition-colors">
                                        Sincronizza Selezionati
                                    </button>
                                </div>
                                <p id="sync-status-message" class="mt-4 text-center font-semibold hidden"></p>
                            </div>
                            
                            <div id="sync-report-table-container" class="mt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <fieldset class="flex items-center space-x-4">
                                        <legend class="sr-only">Filtri</legend>
                                        <div class="flex items-center">
                                            <input id="filter-all" class="h-4 w-4 text-indigo-600" name="filter-type" type="radio" value="all" checked>
                                            <label for="filter-all" class="ml-2 block text-sm font-medium">Tutti</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="filter-toupdate" class="h-4 w-4 text-indigo-600" name="filter-type" type="radio" value="to-update">
                                            <label for="filter-toupdate" class="ml-2 block text-sm font-medium">Da Aggiornare</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="filter-errors" class="h-4 w-4 text-indigo-600" name="filter-type" type="radio" value="error">
                                            <label for="filter-errors" class="ml-2 block text-sm font-medium">Solo Errori</label>
                                        </div>
                                        <div id="synced-filter-container" class="flex items-center hidden">
                                            <input id="filter-synced" class="h-4 w-4 text-indigo-600" name="filter-type" type="radio" value="synced">
                                            <label for="filter-synced" class="ml-2 block text-sm font-medium">Solo Sincronizzati</label>
                                        </div>
                                        <div id="duplicate-filter-container" class="flex items-center hidden">
                                            <input id="filter-duplicates" class="h-4 w-4 text-indigo-600" name="filter-type" type="radio" value="duplicates">
                                            <label for="filter-duplicates" class="ml-2 block text-sm font-medium">Solo Duplicati</label>
                                        </div>
                                    </fieldset>
                                    <button id="download-csv-button" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 text-sm">
                                        Scarica Report
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead id="sync-report-table-head" class="bg-gray-50"></thead>
                                        <tbody id="sync-report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                                <div id="sync-pagination-controls" class="mt-4 flex items-center justify-between">
                                    <button id="sync-prev-page-button" class="bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:bg-gray-200 disabled:cursor-not-allowed">&larr; Precedente</button>
                                    <span id="sync-page-indicator" class="text-sm font-semibold"></span>
                                    <button id="sync-next-page-button" class="bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:bg-gray-200 disabled:cursor-not-allowed">Successivo &rarr;</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <div id="verify-tab-content" class="hidden">
                <main class="space-y-8">
                    <div id="verify-section" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div id="verify-placeholder">
                            <h2 class="text-xl font-semibold mb-2">Verifica Contenuto File</h2>
                            <p class="text-gray-600">Carica un file nella scheda "Sincronizzazione" per attivare la ricerca qui.</p>
                        </div>
                        <div id="verify-controls" class="hidden">
                             <h2 class="text-xl font-semibold mb-4">Cerca nel File Caricato</h2>
                            <div class="flex gap-4">
                                <input type="search" id="search-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Scrivi qui per cercare in qualsiasi colonna...">
                            </div>
                            <div id="verify-table-container" class="mt-6">
                               <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead id="verify-table-head" class="bg-gray-50"></thead>
                                        <tbody id="verify-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                               </div>
                               <p id="verify-no-results" class="text-center text-gray-500 mt-4 hidden">Nessun risultato trovato.</p>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        // --- ELEMENTI DEL DOM GLOBALI ---
        let passwordOverlay, passwordInput, loginButton, passwordError, appContainer;
        let syncTabButton, verifyTabButton, syncTabContent, verifyTabContent;
        let rawImportTabButton, syncReportTabButton, rawImportContent, syncReportContent;
        let dropZone, fileInput, fileNameDisplay, analyzeButton, resultsSection, summaryContainer;
        let loader, loaderText, syncActionArea, syncButton, confirmSyncCheckbox, syncStatusMessage;
        let errorMessageBox, errorMessageText, progressBarContainer, progressBar, downloadCsvButton;
        let rawSearchInput, downloadRawCsvButton;
        let rawImportTableHead, rawImportTableBody;
        let rawPrevPageButton, rawNextPageButton, rawPageIndicator;
        let verifySearchInput, verifyTableHead, verifyTableBody, verifyNoResults, verifyControls, verifyPlaceholder;
        let syncReportTableHead, syncReportTableBody, syncPrevPageButton, syncNextPageButton, syncPageIndicator, filterRadios, duplicateFilterContainer, syncedFilterContainer;

        // --- STATO CONDIVISO ---
        let uploadedFile = null;
        let verificationData = []; // Dati per la tab "Verifica File"
        let analysisResults = []; // Report di Sincronizzazione (consolidato)
        let rawImportData = []; // Dati importati da Supabase (Raw)
        let duplicateRows = []; // Righe duplicate nel file excel importato
        let fileDataRaw = []; // Dati grezzi dal file Excel, usati per l'analisi iniziale

        let currentPage = 1; // Paginazione del report di sincronizzazione
        let rawCurrentPage = 1; // Paginazione del report raw
        let verifyCurrentPage = 1; // Paginazione della verifica
        const ROWS_PER_PAGE = 100;
        const SUPABASE_INGEST_CHUNK_SIZE = 50;

        // --- CREDENZIALI SUPABASE (SOSTITUISCI CON LE TUE) ---
        const SUPABASE_URL_FRONTEND = "https://wqgfgvovwzcancgdsadc.supabase.co"; 
        const SUPABASE_ANON_KEY_FRONTEND = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxZ2Zndm92d3pjYW5jZ2RzYWRjIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MjE0MzI4NCwiZXhwIjoyMDY3NzE5Mjg0fQ.RRqHQQfwwFkALC6Gabz-rdVGWH17rK3Alw6ythD_ajk"; 
        let supabaseClient = null;

        // --- FUNZIONI DI UTILITY ---

        function showErrorMessage(message) {
            errorMessageText.innerHTML = message;
            errorMessageBox.classList.remove('hidden');
        }

        function hideErrorMessage() {
            errorMessageBox.classList.add('hidden');
            errorMessageText.textContent = '';
        }

        function updateProgressBar(current, total) {
            const percentage = (current / total) * 100;
            progressBar.style.width = `${percentage}%`;
        }
        
        function getStatusInfo(status) {
            const icons = { 
                success: `<svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`, 
                'to-update': `<svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path></svg>`, 
                'no-change': `<svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`, 
                'not-found': `<svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`, 
                error: `<svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`, 
                'to-ingest': `<svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>` 
            };

            switch (status) {
                case 'success': return { label: 'Sincronizzato', badgeClass: 'bg-green-100 text-green-800', icon: icons.success, rowClass: 'bg-green-50' };
                case 'to-update': return { label: 'Da Aggiornare', badgeClass: 'bg-blue-100 text-blue-800', icon: icons['to-update'], rowClass: 'bg-blue-50' };
                case 'no-change': return { label: 'Nessuna Modifica', badgeClass: 'bg-gray-100 text-gray-800', icon: icons['no-change'], rowClass: '' };
                case 'not-found': return { label: 'Non Trovato', badgeClass: 'bg-yellow-100 text-yellow-800', icon: icons['not-found'], rowClass: 'bg-yellow-50' };
                case 'error': return { label: 'Errore', badgeClass: 'bg-red-100 text-red-800', icon: icons.error, rowClass: 'bg-red-50' };
                case 'to-ingest': return { label: 'Da Ingerire', badgeClass: 'bg-purple-100 text-purple-800', icon: icons['to-ingest'], rowClass: 'bg-purple-50' };
                default: return { label: 'Sconosciuto', badgeClass: 'bg-gray-100 text-gray-800', icon: '', rowClass: '' };
            }
        }

        // Funzione di utilità per leggere i dati da una riga in modo flessibile
        function getValue(obj, keys) {
            if (!obj) return undefined;
            for (const key of keys) {
                const value = obj[key];
                if (value !== undefined && value !== null) {
                    return value;
                }
            }
            // Fallback per trovare chiavi con nomi simili (es. "minsan" vs "Minsan")
            const lowerCaseKeys = keys.map(k => k.toLowerCase().trim());
            for (const objKey in obj) {
                if (lowerCaseKeys.includes(objKey.toLowerCase().trim())) {
                    return obj[objKey];
                }
            }
            return undefined;
        }

        // Conversione da data Excel a data JS (ISO YYYY-MM-DD)
        function excelDateToJSDate(value) {
            if (typeof value === 'number') {
                if (!value) return null;
                // Excel date conversion logic
                if (value < 60) {
                    value--;
                }
                const date_info = new Date((value - 25569) * 86400 * 1000); // 25569 = giorni tra 1900-01-01 e 1970-01-01
                const year = date_info.getUTCFullYear();
                const month = String(date_info.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date_info.getUTCDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            if (typeof value === 'string' && value.trim()) {
                let parts = [];
                if (value.includes('/')) {
                    parts = value.split('/');
                } else if (value.includes('-')) {
                    parts = value.split('-');
                }

                if (parts.length === 3) {
                    let day, month, year;
                    // Assumiamo DD/MM/YYYY o YYYY/MM/DD
                    if (parts[2].length === 4) {
                        day = parts[0];
                        month = parts[1];
                        year = parts[2];
                    } else if (parts[0].length === 4) {
                        year = parts[0];
                        month = parts[1];
                        day = parts[2];
                    }
                    if (year && month && day) {
                        const isoDateString = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        const d = new Date(isoDateString);
                        // Verifica se la data è valida e corrisponde alla stringa ISO
                        if (d && !isNaN(d.getTime())) {
                            return isoDateString;
                        }
                    }
                }
            }
            return null; // Ritorna null se non è una data valida
        }

        // --- Funzioni di Backend/API ---

        // Funzione per chiamare il backend (shopify-proxy.js)
        async function callShopifyBackend(payload) {
            const response = await fetch('/.netlify/functions/shopify-proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `Errore server: ${response.statusText}`);
            if (data.error) throw new Error(data.error);
            return data;
        }

        // Funzione per chiamare la funzione di ingestione Supabase (supabase-ingest.js)
        async function callSupabaseIngest(payload) {
            const response = await fetch('/.netlify/functions/supabase-ingest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `Errore server: ${response.statusText}`);
            if (data.error) throw new Error(data.error);
            return data;
        }

        // --- Gestione Supabase e Caricamento Dati ---

        function initializeSupabaseClient() {
            if (typeof supabase !== 'undefined' && supabase.createClient && SUPABASE_URL_FRONTEND && SUPABASE_ANON_KEY_FRONTEND && SUPABASE_URL_FRONTEND !== "YOUR_SUPABASE_URL_HERE") {
                supabaseClient = supabase.createClient(SUPABASE_URL_FRONTEND, SUPABASE_ANON_KEY_FRONTEND);
                console.log("Supabase client initialized.");
            } else {
                console.error("Supabase client not initialized. Check URL/Anon Key or Supabase library.");
            }
        }

        // Funzione per caricare i dati RAW importati da Supabase (TAB "Dati Importati Raw")
        async function loadRawImportData() {
            if (!supabaseClient) {
                showErrorMessage("<strong>Errore:</strong> Impossibile caricare i dati raw. Le credenziali Supabase non sono configurate correttamente.");
                return;
            }
            loader.classList.remove('hidden');
            loaderText.textContent = 'Caricamento dati raw da Supabase...';
            hideErrorMessage();

            try {
                // Recupera gli ultimi 1000 record per non sovraccaricare la visualizzazione
                const { data, error } = await supabaseClient
                    .from('inventory_updates')
                    .select(`
                        id,
                        quantity_from_file,
                        expiry_date_from_file,
                        status,
                        details,
                        ditta,
                        batch_number,
                        costo_base,
                        costo_medio,
                        ultimo_costo_ditta,
                        data_ultimo_costo_ditta,
                        prezzo_bd,
                        iva_value,
                        created_at,
                        products (
                            sku_or_minsan,
                            title,
                            shopify_product_id,
                            shopify_variant_id,
                            shopify_inventory_item_id
                        ),
                        shopify_on_hand_quantity,
                        shopify_available_quantity,
                        shopify_committed_quantity,
                        shopify_unavailable_quantity,
                        shopify_expiry_date
                    `)
                    .order('created_at', { ascending: false })
                    .limit(1000); // Limita per performance

                if (error) {
                    throw new Error(error.message);
                }

                rawImportData = data.map(item => ({
                    minsan: item.products?.sku_or_minsan,
                    title: item.products?.title,
                    giacenzaFile: item.quantity_from_file,
                    scadenzaFile: item.expiry_date_from_file,
                    status: item.status,
                    details: item.details,
                    Ditta: item.ditta,
                    lotto: item.batch_number,
                    CostoBase: item.costo_base,
                    CostoMedio: item.costo_medio,
                    UltimoCostoDitta: item.ultimo_costo_ditta,
                    DataUltimoCostoDitta: item.data_ultimo_costo_ditta,
                    PrezzoBD: item.prezzo_bd,
                    IVAValue: item.iva_value,
                    shopify_product_id: item.products?.shopify_product_id,
                    shopify_variant_id: item.products?.shopify_variant_id,
                    shopify_inventory_item_id: item.products?.shopify_inventory_item_id,
                    shopify_on_hand_quantity: item.shopify_on_hand_quantity,
                    shopify_available_quantity: item.shopify_available_quantity,
                    shopify_committed_quantity: item.shopify_committed_quantity,
                    shopify_unavailable_quantity: item.shopify_unavailable_quantity,
                    shopify_expiry_date: item.shopify_expiry_date,
                    created_at: item.created_at
                }));

                rawCurrentPage = 1;
                displayRawImportTablePage(rawCurrentPage);
                resultsSection.classList.remove('hidden');
                loader.classList.add('hidden');
                
            } catch (error) {
                console.error("Errore durante il caricamento dati raw da Supabase:", error);
                showErrorMessage(`<strong>Errore nel caricamento dati raw da Supabase:</strong> ${error.message}`);
                loader.classList.add('hidden');
            }
        }

        // Funzione per caricare i dati CONSOLIDATI del report di sincronizzazione (TAB "Report di Sincronizzazione")
        async function loadSyncReportData() {
            if (!supabaseClient) {
                showErrorMessage("<strong>Errore:</strong> Impossibile caricare il report di sincronizzazione. Le credenziali Supabase non sono configurate correttamente.");
                return;
            }
            loader.classList.remove('hidden');
            loaderText.textContent = 'Caricamento report di sincronizzazione da Supabase...';
            hideErrorMessage();

            try {
                // Recupera gli ultimi record di aggiornamento per consolidarli
                const { data, error } = await supabaseClient
                    .from('inventory_updates')
                    .select(`
                        id,
                        quantity_from_file,
                        expiry_date_from_file,
                        status,
                        details,
                        created_at,
                        products (
                            sku_or_minsan,
                            title,
                            shopify_product_id,
                            shopify_variant_id,
                            shopify_inventory_item_id
                        ),
                        shopify_on_hand_quantity,
                        shopify_available_quantity,
                        shopify_committed_quantity,
                        shopify_unavailable_quantity,
                        shopify_expiry_date
                    `)
                    .order('created_at', { ascending: false })
                    .limit(1000); // Limita per performance

                if (error) {
                    throw new Error(error.message);
                }

                // Logica di consolidamento in JS
                const consolidatedMap = new Map();
                data.forEach(item => {
                    const minsan = item.products?.sku_or_minsan;
                    if (!minsan) return; 

                    if (!consolidatedMap.has(minsan)) {
                        // Inizializza il record consolidato usando le informazioni più recenti
                        consolidatedMap.set(minsan, {
                            minsan: minsan,
                            title: item.products?.title,
                            descrizione: item.products?.title,
                            giacenzaFile: 0, 
                            scadenzaFile: null, 
                            shopify_product_id: item.products?.shopify_product_id,
                            shopify_variant_id: item.products?.shopify_variant_id,
                            shopify_inventory_item_id: item.products?.shopify_inventory_item_id,
                            inventory_quantity: item.shopify_on_hand_quantity, 
                            committed_quantity: item.shopify_committed_quantity,
                            available_quantity: item.shopify_available_quantity,
                            on_hand_quantity: item.shopify_on_hand_quantity,
                            expiry_date: item.shopify_expiry_date,
                            status: item.status, 
                            details: item.details,
                            selected: false,
                        });
                    }

                    const consolidatedItem = consolidatedMap.get(minsan);
                    
                    // Somma le giacenze di tutti i lotti importati
                    consolidatedItem.giacenzaFile += item.quantity_from_file;
                    
                    // Trova la scadenza più breve
                    if (item.expiry_date_from_file) {
                        const currentExpiryDate = new Date(item.expiry_date_from_file);
                        if (!consolidatedItem.scadenzaFile || currentExpiryDate < new Date(consolidatedItem.scadenzaFile)) {
                            consolidatedItem.scadenzaFile = item.expiry_date_from_file;
                        }
                    }

                    // Aggiorna lo stato e i dettagli con l'ultimo record (grazie all'ordinamento per data)
                    consolidatedItem.status = item.status;
                    consolidatedItem.details = item.details;
                });

                analysisResults = Array.from(consolidatedMap.values()); 
                
                // Popola duplicateRows solo se abbiamo dati raw validi (dal file importato)
                if (fileDataRaw.length > 0) {
                     const skuMapForDuplicates = new Map();
                     fileDataRaw.forEach(row => {
                         const sku = String(getValue(row, ['Minsan', 'EAN']) || '').trim();
                         if (sku) {
                             if (!skuMapForDuplicates.has(sku)) skuMapForDuplicates.set(sku, []);
                             skuMapForDuplicates.get(sku).push(row);
                         }
                     });
                     duplicateRows = []; 
                     skuMapForDuplicates.forEach((rows, sku) => {
                         if (rows.length > 1) {
                             duplicateRows.push(...rows.map(r => ({...r, Minsan: sku}))); 
                         }
                     });
                }
                
                displaySummary();
                currentPage = 1;
                displaySyncReportTablePage(currentPage);
                resultsSection.classList.remove('hidden');
                loader.classList.add('hidden');
                updateUIState();
                
            } catch (error) {
                console.error("Errore durante il caricamento report di sincronizzazione da Supabase:", error);
                showErrorMessage(`<strong>Errore nel caricamento report di sincronizzazione da Supabase:</strong> ${error.message}`);
                loader.classList.add('hidden');
            }
        }

        // --- Logica di Elaborazione File (Analisi e Ingestione) ---

        function handleFileSync(file) {
            uploadedFile = file;
            fileNameDisplay.textContent = file.name;
            analyzeButton.disabled = false;
        }

        async function analyzeFile() {
            hideErrorMessage();
            resultsSection.classList.add('hidden');
            loader.classList.remove('hidden');
            analyzeButton.disabled = true;

            try {
                loaderText.textContent = 'Lettura file Excel...';
                const data = await uploadedFile.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                fileDataRaw = XLSX.utils.sheet_to_json(worksheet);

                if (fileDataRaw.length === 0) {
                    throw new Error("Il file Excel è vuoto o non contiene dati validi.");
                }

                // Emetti un evento per notificare la tab "Verifica File" che i dati sono pronti
                window.dispatchEvent(new CustomEvent('data-loaded-for-verification', { detail: fileDataRaw }));

                // Rileva SKU/Minsan e giacenze per l'ingestione e l'analisi
                const productsToIngest = [];
                const allSkusFromRawFile = new Set();

                fileDataRaw.forEach(row => {
                    const minsan = String(getValue(row, ['Minsan', 'EAN']) || '').trim();
                    const giacenza = getValue(row, ['Giacenza', 'giacenza']);
                    const scadenza = getValue(row, ['Scadenza', 'scadenza']);

                    let giacenzaFile = parseInt(giacenza, 10);
                    let scadenzaFile = excelDateToJSDate(scadenza);

                    if (minsan && !isNaN(giacenzaFile)) {
                        allSkusFromRawFile.add(minsan);
                        
                        productsToIngest.push({
                            minsan: minsan,
                            descrizione: getValue(row, ['Descrizione', 'descrizione']),
                            giacenzaFile,
                            scadenzaFile,
                            Ditta: getValue(row, ['Ditta', 'ditta']),
                            lotto: getValue(row, ['lotto', 'Lotto']),
                            CostoBase: getValue(row, ['CostoBase', 'costo_base']),
                            CostoMedio: getValue(row, ['CostoMedio', 'costo_medio']),
                            UltimoCostoDitta: getValue(row, ['UltimoCostoDitta', 'ultimo_costo_ditta']),
                            DataUltimoCostoDitta: excelDateToJSDate(getValue(row, ['DataUltimoCostoDitta', 'data_ultimo_costo_ditta'])),
                            PrezzoBD: getValue(row, ['PrezzoBD', 'prezzo_bd']),
                            IVAValue: getValue(row, ['IVA', 'iva']),
                            status: 'to-ingest', // Stato iniziale prima dell'ingestione
                            details: 'Pronto per l\'ingestione',
                        });
                    } else {
                        // Se manca Minsan o Giacenza, segna come errore nel report Raw
                        productsToIngest.push({
                            minsan: minsan || 'N/D',
                            giacenzaFile: isNaN(giacenzaFile) ? 'N/D' : giacenzaFile,
                            status: 'error',
                            details: 'Dati Giacenza/Minsan mancanti o non validi nel file',
                        });
                    }
                });

                if (productsToIngest.length === 0) {
                    throw new Error("Nessuna riga valida trovata per l'ingestione.");
                }

                // Ingestione dei dati in Supabase a blocchi
                const supabaseIngestChunks = [];
                for (let i = 0; i < productsToIngest.length; i += SUPABASE_INGEST_CHUNK_SIZE) {
                    supabaseIngestChunks.push(productsToIngest.slice(i, i + SUPABASE_INGEST_CHUNK_SIZE));
                }

                progressBarContainer.classList.remove('hidden');
                loaderText.textContent = `Salvataggio dati su Supabase (0/${supabaseIngestChunks.length} pacchetti)...`;
                
                let totalIngested = 0;
                for (let i = 0; i < supabaseIngestChunks.length; i++) {
                    loaderText.textContent = `Salvataggio dati su Supabase (${i + 1}/${supabaseIngestChunks.length} pacchetti)...`;
                    
                    // Invia il chunk al backend per l'ingestione e la verifica Shopify
                    const ingestResponse = await callSupabaseIngest({ productsToIngest: supabaseIngestChunks[i] });
                    
                    if (!ingestResponse.success) {
                        throw new Error(ingestResponse.error || `Errore durante il salvataggio del pacchetto ${i + 1} su Supabase.`);
                    }
                    totalIngested += ingestResponse.ingestedCount;
                    updateProgressBar(i + 1, supabaseIngestChunks.length);
                    
                    // Pause tra i chunk per evitare sovraccarichi
                    if (supabaseIngestChunks.length > 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                console.log('Tutti i dati inviati a Supabase con successo. Totale prodotti ingeriti:', totalIngested);

                // Dopo l'ingestione, passa automaticamente alla visualizzazione del report
                showSyncReportView(); 

            } catch (error) {
                console.error("Errore durante l'analisi o l'ingestione:", error);
                showErrorMessage(`<strong>Errore di Analisi o Ingestione:</strong> ${error.message}`);
                resultsSection.classList.add('hidden');
            } finally {
                loader.classList.add('hidden');
                analyzeButton.disabled = false;
                progressBarContainer.classList.add('hidden');
            }
        }
        
        async function syncFile() {
            hideErrorMessage();
            const itemsToUpdate = analysisResults.filter(r => r.selected && r.status === 'to-update');
            
            if (itemsToUpdate.length === 0) {
                showErrorMessage("<strong>Nessun prodotto da sincronizzare selezionato.</strong>");
                return;
            }

            syncButton.disabled = true;
            confirmSyncCheckbox.disabled = true;
            loader.classList.remove('hidden');
            progressBarContainer.classList.remove('hidden');
            syncStatusMessage.classList.add('hidden');
            
            const chunkSize = 50; // Shopify API limita a 50 aggiornamenti per chiamata
            const itemChunks = [];
            for (let i = 0; i < itemsToUpdate.length; i += chunkSize) {
                itemChunks.push(itemsToUpdate.slice(i, i + chunkSize));
            }
            
            let successCount = 0;
            let failureCount = 0;
            
            for (let i = 0; i < itemChunks.length; i++) {
                const chunk = itemChunks[i];
                loaderText.textContent = `Sincronizzazione pacchetto ${i + 1} di ${itemChunks.length}...`;

                try {
                    const payload = { 
                        type: 'sync', 
                        items: chunk.map(item => ({ 
                            productId: item.shopify_product_id, 
                            variantId: item.shopify_variant_id, 
                            inventoryItemId: item.shopify_inventory_item_id, 
                            quantity: Math.max(0, item.giacenzaFile), 
                            expiryDate: item.scadenzaFile || null 
                        }))
                    };
                    
                    const result = await callShopifyBackend(payload); 
                    
                    // Aggiorna lo stato nel frontend per i prodotti sincronizzati
                    chunk.forEach(item => {
                        const originalItem = analysisResults.find(r => r.minsan === item.minsan);
                        if (originalItem) {
                            originalItem.status = 'success';
                            originalItem.details = `Sincronizzato con successo.`;
                            originalItem.inventory_quantity = Math.max(0, originalItem.giacenzaFile);
                            if (originalItem.scadenzaFile) originalItem.expiry_date = originalItem.scadenzaFile;
                        }
                    });
                    successCount += chunk.length;

                } catch (error) {
                    // Gestisce gli errori a livello di chunk o singolo item
                    chunk.forEach(item => {
                        const originalItem = analysisResults.find(r => r.minsan === item.minsan);
                        if (originalItem) {
                            originalItem.status = 'error';
                            originalItem.details = `Errore durante la sincronizzazione: ${error.message}`;
                        }
                    });
                    failureCount += chunk.length;
                    console.error(`Errore aggiornamento pacchetto ${i + 1}:`, error);
                    showErrorMessage(`<strong>Errore di sincronizzazione:</strong> ${error.message}`);
                }
                
                // Aggiorna la barra di progresso
                updateProgressBar(i + 1, itemChunks.length);
                
                // Pausa tra le chiamate API per rispettare i limiti di Shopify
                if(itemChunks.length > 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            // Pulisci le selezioni e aggiorna UI finale
            analysisResults.forEach(item => { if (item.selected) item.selected = false; });
            displaySummary();
            displaySyncReportTablePage(currentPage); 
            loader.classList.add('hidden');
            progressBarContainer.classList.add('hidden');
            
            syncStatusMessage.classList.remove('hidden');
            if (failureCount > 0) {
                syncStatusMessage.textContent = `Completato con ${successCount} successi e ${failureCount} fallimenti. Controlla il report per i dettagli.`;
                syncStatusMessage.className = 'mt-4 text-center font-semibold text-red-700';
            } else {
                syncStatusMessage.textContent = `Sincronizzazione completata per ${successCount} prodotti!`;
                syncStatusMessage.className = 'mt-4 text-center font-semibold text-green-700';
            }

            if (syncedFilterContainer && successCount > 0) syncedFilterContainer.classList.remove('hidden');
            updateUIState();
        }

        // --- Funzioni di Visualizzazione Tabelle e UI ---

        function displaySummary() {
            const summary = { 
                rawTotal: fileDataRaw.length, 
                total: analysisResults.length, 
                duplicates: duplicateRows.length, 
                toUpdate: analysisResults.filter(r => r.status === 'to-update').length, 
                synced: analysisResults.filter(r => r.status === 'success').length, 
                notFound: analysisResults.filter(r => r.status === 'not-found').length, 
                errors: analysisResults.filter(r => r.status === 'error').length 
            };
            
            summaryContainer.innerHTML = `
                <div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold">${summary.rawTotal}</p><p class="text-sm text-gray-600">Righe Totali</p></div>
                <div class="bg-gray-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold">${summary.total}</p><p class="text-sm text-gray-600">Prodotti Unici</p></div>
                <div class="bg-yellow-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-yellow-800">${summary.duplicates}</p><p class="text-sm text-yellow-700">Righe Duplicate</p></div>
                <div class="bg-blue-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-blue-800">${summary.toUpdate}</p><p class="text-sm text-blue-700">Da Aggiornare</p></div>
                <div class="bg-green-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-green-800">${summary.synced}</p><p class="text-sm text-green-700">Sincronizzati</p></div>
                <div class="bg-yellow-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-yellow-800">${summary.notFound}</p><p class="text-sm text-yellow-700">Non Trovati</p></div>
                <div class="bg-red-100 p-4 rounded-lg text-center"><p class="text-2xl font-bold text-red-800">${summary.errors}</p><p class="text-sm text-red-700">Errori Dati</p></div>
            `;
        }

        // Funzione per visualizzare la tabella del Report di Sincronizzazione
        function displaySyncReportTablePage(page) {
            currentPage = page; 
            const filterValue = document.querySelector('input[name="filter-type"]:checked').value;
            let dataToDisplay = analysisResults;

            // Applica filtri
            if (filterValue === 'to-update') dataToDisplay = analysisResults.filter(r => r.status === 'to-update');
            else if (filterValue === 'error') dataToDisplay = analysisResults.filter(r => r.status === 'error');
            else if (filterValue === 'duplicates') {
                dataToDisplay = duplicateRows.map(row => ({
                    minsan: getValue(row, ['Minsan', 'EAN']),
                    descrizione: getValue(row, ['Descrizione', 'descrizione']),
                    giacenzaFile: getValue(row, ['Giacenza', 'giacenza']),
                    scadenzaFile: excelDateToJSDate(getValue(row, ['Scadenza', 'scadenza'])),
                    status: 'duplicate',
                    details: 'Riga duplicata rilevata nel file importato',
                    _debug_source_row: row 
                }));
            }
            else if (filterValue === 'synced') dataToDisplay = analysisResults.filter(r => r.status === 'success');
            
            // Paginazione
            const totalPages = Math.ceil(dataToDisplay.length / ROWS_PER_PAGE);
            const paginatedItems = dataToDisplay.slice((page - 1) * ROWS_PER_PAGE, page * ROWS_PER_PAGE);
            
            renderSyncReportTable(paginatedItems, filterValue === 'duplicates');
            
            syncPageIndicator.textContent = `Pagina ${page} di ${totalPages || 1}`;
            syncPrevPageButton.disabled = page === 1;
            syncNextPageButton.disabled = page === totalPages || totalPages === 0;
            updateUIState();
        }

        // Funzione per renderizzare la tabella del Report di Sincronizzazione
        function renderSyncReportTable(items, isDuplicateView) {
            syncReportTableBody.innerHTML = '';

            if (isDuplicateView) {
                // Intestazioni per la vista Duplicati
                syncReportTableHead.innerHTML = `
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Minsan/SKU</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase min-w-[200px]">Descrizione</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Giacenza File</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Scadenza File</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dettagli</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase text-red-600">DEBUG (Raw Data)</th>
                    </tr>
                `;
                items.forEach(res => {
                    const debugData = JSON.stringify(res._debug_source_row || res, null, 2);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-3 py-4 whitespace-nowrap text-xs font-medium">${res.minsan}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs">${res.descrizione || ''}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs">${res.giacenzaFile ?? 'N/D'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs">${res.scadenzaFile || 'N/D'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-600">${res.details || ''}</td>
                        <td class="p-2 debug-cell">${debugData}</td>
                    `;
                    syncReportTableBody.appendChild(row);
                });

            } else {
                // Intestazioni per il Report di Sincronizzazione (consolidato)
                syncReportTableHead.innerHTML = `
                    <tr>
                        <th class="px-2 py-3"><input type="checkbox" id="select-all-checkbox" class="h-4 w-4 text-indigo-600 rounded"></th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Minsan/SKU</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase min-w-[200px]">Descrizione</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">On Hand (Shopify)</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Committed</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Available</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Giac. File (Consol.)</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Scad. Shopify</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Scad. File (Consol.)</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stato</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dettagli</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase text-red-600">DEBUG</th>
                    </tr>
                `;
                
                items.forEach(res => {
                    const statusInfo = getStatusInfo(res.status);
                    const row = document.createElement('tr');
                    row.className = statusInfo.rowClass;
                    
                    let checkboxHTML = '<td class="px-2 py-4"></td>';
                    if (res.status === 'to-update') {
                        checkboxHTML = `<td class="px-2 py-4"><input type="checkbox" class="h-4 w-4 text-indigo-600 rounded row-checkbox" data-minsan="${res.minsan}" ${res.selected ? 'checked' : ''}></td>`;
                    }
                    
                    // Utilizza un fallback robusto per i dati di debug
                    const debugData = JSON.stringify(res._debug_source_row || res, null, 2);

                    // Qui usiamo una template literal per inserire i dati nella riga
                    row.innerHTML = `
                        ${checkboxHTML}
                        <td class="px-3 py-4 whitespace-nowrap text-xs font-medium">${res.minsan}</td>
                        <td class="px-3 py-4 text-xs">${res.title || res.descrizione || 'N/D'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs">${res.on_hand_quantity ?? 'N/D'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs">${res.committed_quantity ?? 'N/D'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs">${res.available_quantity ?? 'N/D'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs font-semibold">${res.giacenzaFile}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs">${res.expiry_date || 'N/D'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs font-semibold">${res.scadenzaFile || 'N/D'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs ${statusInfo.badgeClass}">
                                ${statusInfo.icon} ${statusInfo.label}
                            </span>
                        </td>
                        <td class="px-3 py-4 text-xs text-gray-600">${res.details || ''}</td>
                        <td class="p-2 debug-cell">${debugData}</td>
                    `;
                    syncReportTableBody.appendChild(row);
                });
            }
        }

        // Funzione per visualizzare la tabella dei Dati Importati (Raw)
        function displayRawImportTablePage(page) {
            rawCurrentPage = page;
            const searchTerm = rawSearchInput.value.toLowerCase();
            let dataToDisplay = rawImportData;

            if (searchTerm) {
                dataToDisplay = rawImportData.filter(item =>
                    Object.values(item).some(val =>
                        String(val).toLowerCase().includes(searchTerm)
                    )
                );
            }

            const totalPages = Math.ceil(dataToDisplay.length / ROWS_PER_PAGE);
            const paginatedItems = dataToDisplay.slice((page - 1) * ROWS_PER_PAGE, page * ROWS_PER_PAGE);

            renderRawImportTable(paginatedItems);

            rawPageIndicator.textContent = `Pagina ${page} di ${totalPages || 1}`;
            rawPrevPageButton.disabled = page === 1;
            rawNextPageButton.disabled = page === totalPages || totalPages === 0;
        }

        function renderRawImportTable(items) {
            rawImportTableBody.innerHTML = '';
            
            if (items.length === 0) {
                rawImportTableHead.innerHTML = '';
                rawImportTableBody.innerHTML = '<tr><td colspan="15" class="text-center py-4 text-gray-500">Nessun dato raw da visualizzare.</td></tr>';
                return;
            }

            const headers = [
                'Minsan/SKU', 'Descrizione', 'Ditta', 'Lotto', 'Giacenza File', 'Scadenza File',
                'Costo Base', 'Costo Medio', 'Ultimo Costo Ditta', 'Data Ultimo Costo Ditta',
                'Prezzo BD', 'IVA Value',
                'Shopify Product ID', 'Shopify Variant ID', 'Shopify Inventory Item ID',
                'Shopify On Hand', 'Shopify Available', 'Shopify Committed', 'Shopify Unavailable', 'Shopify Expiry',
                'Stato Ingestione', 'Dettagli Ingestione', 'Ingested At'
            ];
            rawImportTableHead.innerHTML = `<tr>${headers.map(h => `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`).join('')}</tr>`;

            items.forEach(item => {
                const statusInfo = getStatusInfo(item.status);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-xs font-medium">${item.minsan ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.title || item.descrizione ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.Ditta ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.lotto ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.giacenzaFile ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.scadenzaFile || 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.CostoBase ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.CostoMedio ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.UltimoCostoDitta ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.DataUltimoCostoDitta || 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.PrezzoBD ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.IVAValue ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.shopify_product_id ? item.shopify_product_id.split('/').pop() : 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.shopify_variant_id ? item.shopify_variant_id.split('/').pop() : 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.shopify_inventory_item_id ? item.shopify_inventory_item_id.split('/').pop() : 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.shopify_on_hand_quantity ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.shopify_available_quantity ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.shopify_committed_quantity ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.shopify_unavailable_quantity ?? 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${item.shopify_expiry_date || 'N/D'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs"><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs ${statusInfo.badgeClass}">${statusInfo.icon} ${statusInfo.label}</span></td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-600">${item.details || ''}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">${new Date(item.created_at).toLocaleString()}</td>
                `;
                rawImportTableBody.appendChild(row);
            });
        }
        
        // Funzione per visualizzare la tabella dei Dati Importati (Raw)
        function showRawImportView() {
            rawImportTabButton.classList.add('active');
            syncReportTabButton.classList.remove('active');
            rawImportContent.classList.remove('hidden');
            syncReportContent.classList.add('hidden');
            
            // Carica i dati raw da Supabase solo quando si apre questa tab
            if (rawImportData.length === 0) {
                loadRawImportData();
            } else {
                displayRawImportTablePage(rawCurrentPage);
            }
        }
        
        // Funzione per visualizzare la tabella del Report di Sincronizzazione (Consolidato)
        function showSyncReportView() {
            syncReportTabButton.classList.add('active');
            rawImportTabButton.classList.remove('active');
            syncReportContent.classList.remove('hidden');
            rawImportContent.classList.add('hidden');

            // Carica i dati consolidati da Supabase solo quando si apre questa tab
            if (analysisResults.length === 0) {
                loadSyncReportData();
            } else {
                displaySummary();
                displaySyncReportTablePage(currentPage);
            }
        }

        function updateUIState() {
            const itemsToUpdateSelected = analysisResults.filter(r => r.selected).length > 0;
            const totalToUpdate = analysisResults.filter(r => r.status === 'to-update').length;
            
            confirmSyncCheckbox.disabled = !itemsToUpdateSelected;
            syncButton.disabled = !confirmSyncCheckbox.checked || !itemsToUpdateSelected;
            syncActionArea.classList.toggle('hidden', totalToUpdate === 0 && analysisResults.length > 0);
            
            const selectAll = document.getElementById('select-all-checkbox');
            if (selectAll) {
                const updatableItemsOnPage = document.querySelectorAll('.row-checkbox');
                selectAll.checked = updatableItemsOnPage.length > 0 && Array.from(updatableItemsOnPage).every(cb => cb.checked);
            }
        }

        // --- Gestione Tab Verifica File ---

        function setupVerifyTab() {
            verifySearchInput = document.getElementById('search-input');
            verifyTableHead = document.getElementById('verify-table-head');
            verifyTableBody = document.getElementById('verify-table-body');
            verifyNoResults = document.getElementById('verify-no-results');
            verifyControls = document.getElementById('verify-controls');
            verifyPlaceholder = document.getElementById('verify-placeholder');

            // Listener per i dati importati dalla tab Sync
            window.addEventListener('data-loaded-for-verification', (e) => {
                verificationData = e.detail;
                verifyPlaceholder.classList.add('hidden');
                verifyControls.classList.remove('hidden');
                renderVerifyTable(verificationData);
            });

            // Listener per la ricerca nella tab Verifica
            verifySearchInput.addEventListener('input', () => {
                const searchTerm = verifySearchInput.value.toLowerCase().trim();
                let filteredData = verificationData;

                if (searchTerm) {
                    filteredData = verificationData.filter(row => 
                        Object.values(row).some(value => 
                            String(value).toLowerCase().includes(searchTerm)
                        )
                    );
                }
                
                renderVerifyTable(filteredData);
                verifyNoResults.classList.toggle('hidden', filteredData.length > 0);
            });
        }

        function renderVerifyTable(data) {
            verifyTableBody.innerHTML = '';
            
            if (data.length === 0) {
                verifyTableHead.innerHTML = '';
                verifyNoResults.classList.remove('hidden');
                return;
            }

            verifyNoResults.classList.add('hidden');

            // Genera dinamicamente le intestazioni della tabella basandosi sulla prima riga
            const headers = Object.keys(data[0]);
            verifyTableHead.innerHTML = `
                <tr>${headers.map(h => `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`).join('')}</tr>
            `;

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = headers.map(header => {
                    let cellValue = row[header];
                    // Formatta le date se necessario
                    if (header.toLowerCase().includes('scadenza') || header.toLowerCase().includes('data')) {
                        cellValue = excelDateToJSDate(cellValue) || cellValue;
                    }
                    return `<td class="px-3 py-4 whitespace-nowrap text-xs">${cellValue ?? ''}</td>`;
                }).join('');
                verifyTableBody.appendChild(tr);
            });
        }

        // --- Inizializzazione e Listener Principali ---

        function checkPassword() {
            // Semplice check della password per l'accesso frontend
            // NOTA: Non usare una password fissa e facilmente accessibile per un'app reale in produzione.
            // L'app reale dovrebbe usare un meccanismo di autenticazione sicuro (es. OAuth, Netlify Identity).
            const password = passwordInput.value;
            if (password === 'stock2024') { 
                passwordOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
            } else {
                passwordError.classList.remove('hidden');
            }
        }

        function setupDragAndDrop() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', handleDrop, false);
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFileSync(e.target.files[0]));
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                handleFileSync(file);
            } else {
                showErrorMessage("Formato file non supportato. Carica un file .xlsx o .xls.");
            }
        }

        window.onload = function() {
            // Assegnazione degli elementi DOM
            passwordOverlay = document.getElementById('password-overlay');
            passwordInput = document.getElementById('password-input');
            loginButton = document.getElementById('login-button');
            passwordError = document.getElementById('password-error');
            appContainer = document.getElementById('app-container');

            syncTabButton = document.getElementById('sync-tab-button');
            verifyTabButton = document.getElementById('verify-tab-button');
            syncTabContent = document.getElementById('sync-tab-content');
            verifyTabContent = document.getElementById('verify-tab-content');
            
            rawImportTabButton = document.getElementById('raw-import-tab-button');
            syncReportTabButton = document.getElementById('sync-report-tab-button');
            rawImportContent = document.getElementById('raw-import-content');
            syncReportContent = document.getElementById('sync-report-content');

            dropZone = document.getElementById('drop-zone');
            fileInput = document.getElementById('file-input');
            fileNameDisplay = document.getElementById('file-name');
            analyzeButton = document.getElementById('analyze-button');
            resultsSection = document.getElementById('results-section');
            summaryContainer = document.getElementById('summary');
            loader = document.getElementById('loader');
            loaderText = document.getElementById('loader-text');
            syncActionArea = document.getElementById('sync-action-area');
            syncButton = document.getElementById('sync-button');
            confirmSyncCheckbox = document.getElementById('confirm-sync-checkbox');
            syncStatusMessage = document.getElementById('sync-status-message');
            errorMessageBox = document.getElementById('error-message-box');
            errorMessageText = document.getElementById('error-message-text');
            progressBarContainer = document.getElementById('progress-bar-container');
            progressBar = document.getElementById('progress-bar');
            downloadCsvButton = document.getElementById('download-csv-button');
            
            // Paginazione e filtri Report di Sincronizzazione
            syncReportTableHead = document.getElementById('sync-report-table-head');
            syncReportTableBody = document.getElementById('sync-report-table-body');
            syncPrevPageButton = document.getElementById('sync-prev-page-button');
            syncNextPageButton = document.getElementById('sync-next-page-button');
            syncPageIndicator = document.getElementById('sync-page-indicator');
            filterRadios = document.querySelectorAll('input[name="filter-type"]');
            duplicateFilterContainer = document.getElementById('duplicate-filter-container');
            syncedFilterContainer = document.getElementById('synced-filter-container');

            // Paginazione e ricerca Raw Import
            rawSearchInput = document.getElementById('raw-search-input');
            downloadRawCsvButton = document.getElementById('download-raw-csv-button');
            rawImportTableHead = document.getElementById('raw-import-table-head');
            rawImportTableBody = document.getElementById('raw-import-table-body');
            rawPrevPageButton = document.getElementById('raw-prev-page-button');
            rawNextPageButton = document.getElementById('raw-next-page-button');
            rawPageIndicator = document.getElementById('raw-page-indicator');

            // Inizializza Supabase
            initializeSupabaseClient();
            
            // Configura le tab e la logica di verifica
            setupVerifyTab();

            // Aggiungi tutti gli event listener
            syncTabButton.addEventListener('click', showSyncReportView);
            verifyTabButton.addEventListener('click', () => {
                verifyTabButton.classList.add('active');
                syncTabButton.classList.remove('active');
                verifyTabContent.classList.remove('hidden');
                syncTabContent.classList.add('hidden');
            });

            rawImportTabButton.addEventListener('click', showRawImportView);
            syncReportTabButton.addEventListener('click', showSyncReportView);

            loginButton.addEventListener('click', checkPassword);
            passwordInput.addEventListener('keypress', (e) => e.key === 'Enter' && checkPassword());

            analyzeButton.addEventListener('click', analyzeFile);
            
            confirmSyncCheckbox.addEventListener('change', updateUIState);
            syncButton.addEventListener('click', syncFile);
            downloadCsvButton.addEventListener('click', downloadCSV);
            
            // Event Listeners per il Report di Sincronizzazione
            syncPrevPageButton.addEventListener('click', () => displaySyncReportTablePage(currentPage - 1));
            syncNextPageButton.addEventListener('click', () => displaySyncReportTablePage(currentPage + 1));
            filterRadios.forEach(radio => radio.addEventListener('change', () => { currentPage = 1; displaySyncReportTablePage(currentPage); }));
            
            syncReportTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('row-checkbox')) {
                    const item = analysisResults.find(r => r.minsan === e.target.dataset.minsan);
                    if (item) item.selected = e.target.checked;
                    updateUIState();
                }
            });
            
            syncReportTableHead.addEventListener('change', (e) => {
                if (e.target.id === 'select-all-checkbox') {
                    const isChecked = e.target.checked;
                    // Seleziona/Deseleziona tutti gli elementi 'to-update' nel dataset corrente, anche quelli non visibili sulla pagina
                    analysisResults.forEach(res => { 
                        if (res.status === 'to-update') {
                            res.selected = isChecked;
                        } 
                    });
                    // Aggiorna solo la pagina visualizzata per riflettere lo stato
                    displaySyncReportTablePage(currentPage);
                }
            });

            // Event Listeners per il Raw Import Report
            rawPrevPageButton.addEventListener('click', () => displayRawImportTablePage(rawCurrentPage - 1));
            rawNextPageButton.addEventListener('click', () => displayRawImportTablePage(rawCurrentPage + 1));
            rawSearchInput.addEventListener('input', () => { rawCurrentPage = 1; displayRawImportTablePage(rawCurrentPage); });
            downloadRawCsvButton.addEventListener('click', downloadRawCSV);

            // Abilita Drag & Drop
            setupDragAndDrop();
        };
    </script>
</body>
</html>
