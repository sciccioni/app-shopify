<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ðŸ”„ Inventory Sync</title>

  <!-- Bootswatch Lux Theme -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5/dist/lux/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Alpine.js -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <style>
    [x-cloak] { display: none !important; }
    body { padding-top: 70px; background-color: #f8f9fa; }
    section { display: none; }
    section.active { display: block; }
  </style>
</head>
<body x-data="app()" x-init="init()" x-cloak>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-arrow-repeat"></i> Inventory Sync</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" :class="{active: tab==='upload'}" @click.prevent="tab='upload'" href="#"><i class="bi bi-upload"></i> Importa</a></li>
          <li class="nav-item"><a class="nav-link" :class="{active: tab==='review'}" @click.prevent="tab='review'" href="#"><i class="bi bi-journal-check"></i> Revisione</a></li>
          <li class="nav-item"><a class="nav-link" :class="{active: tab==='markup'}" @click.prevent="tab='markup'" href="#"><i class="bi bi-percent"></i> Markup</a></li>
          <li class="nav-item"><a class="nav-link" :class="{active: tab==='logs'}" @click.prevent="tab='logs'" href="#"><i class="bi bi-clock-history"></i> Log</a></li>
          <li class="nav-item"><a class="nav-link" :class="{active: tab==='data'}" @click.prevent="tab='data'; loadStaging(); loadNormalized()" href="#"><i class="bi bi-table"></i> Dati</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">

    <!-- Status -->
    <div class="alert alert-info" x-show="uploadStatus" x-text="uploadStatus"></div>

    <!-- UPLOAD -->
    <section :class="{ 'active': tab==='upload' }" class="mb-5">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white"><i class="bi bi-upload"></i> Importa Inventario</div>
        <div class="card-body">
          <input type="file" class="form-control mb-3" @change="onFileChange" />
          <button class="btn btn-success" @click="uploadFile()"><i class="bi bi-play-circle"></i> Avvia Importazione</button>
          <div class="progress mt-3" x-show="uploadProgress !== null">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 :style="'width:' + uploadProgress + '%'"
                 x-text="uploadProgress + '%'"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- REVIEW -->
    <section :class="{ 'active': tab==='review' }" class="mb-5">
      <!-- ... come prima ... -->
    </section>

    <!-- MARKUP -->
    <section :class="{ 'active': tab==='markup' }" class="mb-5">
      <!-- ... come prima ... -->
    </section>

    <!-- LOG -->
    <section :class="{ 'active': tab==='logs' }" class="mb-5">
      <!-- ... come prima ... -->
    </section>

    <!-- DATI -->
    <section :class="{ 'active': tab==='data' }" class="mb-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-database-fill"></i> Dati Inventario</h3>
        <button class="btn btn-secondary" @click="pageStaging=1; pageNormalized=1; loadStaging(); loadNormalized()">
          <i class="bi bi-arrow-clockwise"></i> Ricarica
        </button>
      </div>

      <!-- ricerca e conteggi -->
      <div class="row mb-3">
        <div class="col-md-4">
          <input type="text" class="form-control" placeholder="ðŸ” Cerca per MINSAN" x-model="searchMin">
        </div>
        <div class="col-md-8 text-end">
          <span class="me-3">Staging: <strong x-text="filteredStaging.length"></strong> / <em x-text="staging.length"></em></span>
          <span>Normalized: <strong x-text="filteredNormalized.length"></strong> / <em x-text="normalized.length"></em></span>
        </div>
      </div>

      <!-- STAGING -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">Staging Inventory</div>
        <div class="card-body table-responsive">
          <table class="table table-sm table-striped">
            <thead><tr><th>MINSAN</th><th>Lotto</th><th>Qty</th><th>Expiry</th></tr></thead>
            <tbody>
              <template x-for="r in pagedStaging" :key="r.id">
                <tr>
                  <td x-text="r.minsan"></td>
                  <td x-text="r.lotto ?? r.batch"></td>
                  <td x-text="r.giacenza ?? r.raw_quantity"></td>
                  <td x-text="(r.scadenza ?? r.raw_expiry) ? new Date(r.scadenza ?? r.raw_expiry).toLocaleDateString() : '-'"></td>
                </tr>
              </template>
              <tr x-show="!filteredStaging.length">
                <td colspan="4" class="text-center text-muted">Nessun record</td>
              </tr>
            </tbody>
          </table>
          <!-- pagination -->
          <nav><ul class="pagination justify-content-center mb-0">
            <li class="page-item" :class="{disabled: pageStaging===1}">
              <button class="page-link" @click="pageStaging=Math.max(1,pageStaging-1)">Prev</button>
            </li>
            <template x-for="p in totalPagesStaging" :key="p">
              <li class="page-item" :class="{active: pageStaging===p}">
                <button class="page-link" @click="pageStaging=p" x-text="p"></button>
              </li>
            </template>
            <li class="page-item" :class="{disabled: pageStaging===totalPagesStaging}">
              <button class="page-link" @click="pageStaging=Math.min(totalPagesStaging,pageStaging+1)">Next</button>
            </li>
          </ul></nav>
        </div>
      </div>

      <!-- NORMALIZED -->
      <div class="card shadow-sm">
        <div class="card-header bg-light">Normalized Inventory</div>
        <div class="card-body table-responsive">
          <table class="table table-sm table-striped">
            <thead><tr><th>MINSAN</th><th>Qty Totale</th><th>Expiry</th></tr></thead>
            <tbody>
              <template x-for="n in pagedNormalized" :key="n.minsan">
                <tr>
                  <td x-text="n.minsan"></td>
                  <td x-text="n.total_qty"></td>
                  <td x-text="n.expiry ? new Date(n.expiry).toLocaleDateString() : '-'"></td>
                </tr>
              </template>
              <tr x-show="!filteredNormalized.length">
                <td colspan="3" class="text-center text-muted">Nessun record</td>
              </tr>
            </tbody>
          </table>
          <!-- pagination -->
          <nav><ul class="pagination justify-content-center mb-0">
            <li class="page-item" :class="{disabled: pageNormalized===1}">
              <button class="page-link" @click="pageNormalized=Math.max(1,pageNormalized-1)">Prev</button>
            </li>
            <template x-for="p in totalPagesNormalized" :key="p">
              <li class="page-item" :class="{active: pageNormalized===p}">
                <button class="page-link" @click="pageNormalized=p" x-text="p"></button>
              </li>
            </template>
            <li class="page-item" :class="{disabled: pageNormalized===totalPagesNormalized}">
              <button class="page-link" @click="pageNormalized=Math.min(totalPagesNormalized,pageNormalized+1)">Next</button>
            </li>
          </ul></nav>
        </div>
      </div>
    </section>
  </div>

  <script>
  function app() {
    return {
      tab: 'upload',
      importId:'', file:null,
      uploadStatus:'', uploadProgress:null,
      updates:[], companies:[], form:{id:'',name:'',markup_pct:0}, preview:[], logs:[],
      staging:[], normalized:[],

      // search & pagination
      searchMin:'', pageStaging:1, pageNormalized:1, perPage:50,

      init() {
        this.loadCompanies();
        this.loadLogs();
      },
      onFileChange(e) {
        this.file=e.target.files[0];
        this.uploadStatus=''; this.uploadProgress=null;
      },
      async uploadFile() {
        if(!this.file) return alert('Seleziona un file Excel');
        // ... upload/normalize/compare identical a prima ...
        this.$nextTick(()=>{ this.tab='data' });
        await Promise.all([ this.loadUpdates(), this.loadStaging(), this.loadNormalized(), this.loadCompanies(), this.loadLogs() ]);
      },

      // computed
      get filteredStaging() {
        if(!this.searchMin) return this.staging;
        return this.staging.filter(r => String(r.minsan).includes(this.searchMin.trim()));
      },
      get filteredNormalized() {
        if(!this.searchMin) return this.normalized;
        return this.normalized.filter(n => String(n.minsan).includes(this.searchMin.trim()));
      },
      get totalPagesStaging() {
        return Math.max(1, Math.ceil(this.filteredStaging.length/this.perPage));
      },
      get totalPagesNormalized() {
        return Math.max(1, Math.ceil(this.filteredNormalized.length/this.perPage));
      },
      get pagedStaging() {
        const start=(this.pageStaging-1)*this.perPage;
        return this.filteredStaging.slice(start,start+this.perPage);
      },
      get pagedNormalized() {
        const start=(this.pageNormalized-1)*this.perPage;
        return this.filteredNormalized.slice(start,start+this.perPage);
      },

      // load functions
      async loadUpdates(){ /* ... */ },
      async loadCompanies(){ /* ... */ },
      async loadLogs(){ /* ... */ },

      async loadStaging() {
        if(!this.importId) return;
        const r=await fetch(`/.netlify/functions/get-staging?import_id=${this.importId}`);
        this.staging=await r.json();
        if(this.pageStaging>this.totalPagesStaging) this.pageStaging=this.totalPagesStaging;
      },
      async loadNormalized(){
        if(!this.importId) return;
        const r=await fetch(`/.netlify/functions/get-normalized?import_id=${this.importId}`);
        this.normalized=await r.json();
        if(this.pageNormalized>this.totalPagesNormalized) this.pageNormalized=this.totalPagesNormalized;
      },
      async normalizeAndReload(){ /* ... */ },
      async approveSelected(){ /* ... */ },
      saveCompany(){ /* ... */ },
      previewMarkup(){ /* ... */ },
      toggleAll(e){ this.updates.forEach(u=>u.sel=e.target.checked); }
    }
  }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
