<!DOCTYPE html>
<html lang="it" x-data="app()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sync Inventario</title>

  <!-- Bootswatch Lux Theme -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/lux/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-4LG5fTFK3fZFp4iXJZ3ijIeJhYhM6OwGf6B25AXobqD7rjZsyK/zwqWvZn86cP8o"
    crossorigin="anonymous"
  />

  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />

  <!-- Alpine.js -->
  <script
    src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    defer
  ></script>

  <style>
    body { padding-top: 70px; }
    section { display: none; }
    section.active { display: block; }
  </style>
</head>

<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ðŸ”„ Inventory Sync</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navMenu"
        aria-controls="navMenu"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a
              class="nav-link"
              :class="{ active: tab==='upload' }"
              @click.prevent="tab='upload'"
              href="#"
            ><i class="bi bi-upload"></i> Importa</a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              :class="{ active: tab==='review' }"
              @click.prevent="tab='review'"
              href="#"
            ><i class="bi bi-journal-check"></i> Revisione</a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              :class="{ active: tab==='markup' }"
              @click.prevent="tab='markup'"
              href="#"
            ><i class="bi bi-percent"></i> Markup</a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              :class="{ active: tab==='logs' }"
              @click.prevent="tab='logs'"
              href="#"
            ><i class="bi bi-clock-history"></i> Log</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">

    <!-- 1) IMPORTAZIONE EXCEL -->
    <section :class="{ 'active': tab==='upload' }">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-upload"></i> Importa Inventario
        </div>
        <div class="card-body">
          <div class="mb-3">
            <input
              type="file"
              class="form-control"
              @change="onFileChange"
            />
          </div>
          <button
            class="btn btn-success"
            @click="uploadFile()"
          ><i class="bi bi-play-circle"></i> Avvia Importazione</button>

          <!-- Barra di avanzamento -->
          <div class="progress mt-3" x-show="uploadProgress !== null">
            <div
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              :style="'width: ' + uploadProgress + '%'"
              x-text="uploadProgress + '%'"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>

          <div class="mt-3 text-success fw-bold" x-text="uploadStatus"></div>
        </div>
      </div>
    </section>

    <!-- 2) REVISIONE MODIFICHE -->
    <section :class="{ 'active': tab==='review' }">
      <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="bi bi-journal-check"></i> Revisione Modifiche</span>
          <button class="btn btn-success" @click="approveSelected()">
            <i class="bi bi-check2-circle"></i> Approva Selezionati
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th><input type="checkbox" @click="toggleAll($event)" /></th>
                  <th>MINSAN</th>
                  <th>Qty (Old â†’ New)</th>
                  <th>Prezzo (Old â†’ New)</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="u in updates" :key="u.id">
                  <tr>
                    <td><input type="checkbox" x-model="u.sel" /></td>
                    <td x-text="u.minsan"></td>
                    <td x-text="u.old_qty + ' â†’ ' + u.new_qty"></td>
                    <td x-text="u.old_price.toFixed(2) + ' â†’ ' + u.new_price.toFixed(2)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- 3) GESTIONE MARKUP -->
    <section :class="{ 'active': tab==='markup' }">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-percent"></i> Gestione Markup
        </div>
        <div class="card-body">

          <!-- Lista Ditte -->
          <div class="table-responsive mb-4">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Nome Ditta</th>
                  <th>Markup (%)</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="c in companies" :key="c.id">
                  <tr>
                    <td x-text="c.name"></td>
                    <td x-text="c.markup_pct.toFixed(2)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <!-- Form Aggiungi/Modifica -->
          <form @submit.prevent="saveCompany" class="row g-3 mb-4">
            <input type="hidden" x-model="form.id" />
            <div class="col-md-5">
              <label class="form-label">Nome</label>
              <input type="text" class="form-control" x-model="form.name" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">Markup (%)</label>
              <input type="number" class="form-control" x-model="form.markup_pct" step="0.01" required />
            </div>
            <div class="col-md-3 d-flex">
              <button class="btn btn-success me-2" type="submit">
                <i class="bi bi-save"></i> Salva
              </button>
              <button class="btn btn-secondary" type="button" @click="formReset()">
                <i class="bi bi-x-circle"></i> Annulla
              </button>
            </div>
          </form>

          <!-- Anteprima Ricalcolo -->
          <button class="btn btn-info mb-3" @click="previewMarkup()">
            <i class="bi bi-binoculars"></i> Anteprima Ricalcolo
          </button>
          <ul class="list-group">
            <template x-for="p in preview" :key="p.minsan">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span x-text="p.minsan"></span>
                <span x-text="p.old_price.toFixed(2) + ' â†’ ' + p.new_price.toFixed(2)"></span>
              </li>
            </template>
          </ul>

        </div>
      </div>
    </section>

    <!-- 4) LOG AGGIORNAMENTI -->
    <section :class="{ 'active': tab==='logs' }">
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-clock-history"></i> Log Aggiornamenti
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Data</th>
                  <th>MINSAN</th>
                  <th>Azione</th>
                  <th>Esito</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="l in logs" :key="l.id">
                  <tr>
                    <td x-text="new Date(l.executed_at).toLocaleString()"></td>
                    <td x-text="l.minsan"></td>
                    <td x-text="l.action"></td>
                    <td>
                      <span
                        class="badge"
                        :class="l.status==='success' ? 'bg-success' : 'bg-danger'"
                        x-text="l.status"
                      ></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- Alpine.js App Logic -->
  <script>
    function app() {
      return {
        tab: 'upload',
        importId: '',
        file: null,
        uploadStatus: '',
        uploadProgress: null,
        updates: [],
        companies: [],
        form: { id: '', name: '', markup_pct: 0 },
        preview: [],
        logs: [],

        init() {
          if (this.importId) this.loadUpdates();
          this.loadCompanies();
          this.loadLogs();
        },

        onFileChange(e) {
          this.file = e.target.files[0];
          this.uploadStatus = '';
          this.uploadProgress = 0;
        },

        uploadFile() {
          if (!this.file) return alert('Seleziona un file Excel');
          this.uploadStatus = 'Importazione in corsoâ€¦';
          this.uploadProgress = 0;
          const form = new FormData();
          form.append('file', this.file);

          const xhr = new XMLHttpRequest();
          xhr.open('POST', '/.netlify/functions/upload');

          xhr.upload.addEventListener('progress', e => {
            if (e.lengthComputable) {
              this.uploadProgress = Math.round((e.loaded / e.total) * 100);
            }
          });

          xhr.addEventListener('load', async () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              const { import_id, rows_imported } = JSON.parse(xhr.responseText);
              this.importId = import_id;
              this.uploadStatus = `Importate ${rows_imported} righe (import_id: ${import_id})`;
              this.uploadProgress = 100;
              this.loadUpdates();
            } else {
              this.uploadStatus = `Errore: ${xhr.responseText}`;
            }
          });

          xhr.addEventListener('error', () => {
            this.uploadStatus = 'Errore di rete durante l\'upload';
          });

          xhr.send(form);
        },

        async loadUpdates() {
          if (!this.importId) return;
          const r = await fetch(`/.netlify/functions/list-updates?import_id=${this.importId}`);
          this.updates = (await r.json()).map(u => ({ ...u, sel: false }));
        },

        toggleAll(e) {
          this.updates.forEach(u => (u.sel = e.target.checked));
        },

        async approveSelected() {
          const ids = this.updates.filter(u => u.sel).map(u => u.id);
          if (!ids.length) return alert('Seleziona almeno una modifica');
          const r = await fetch('/.netlify/functions/approve', {
            method: 'POST',
            body: JSON.stringify({ update_ids: ids })
          });
          if (r.ok) {
            alert('Approvati con successo');
            this.loadUpdates();
            this.loadLogs();
          } else {
            alert(await r.text());
          }
        },

        async loadCompanies() {
          const r = await fetch('/.netlify/functions/companies');
          this.companies = await r.json();
        },

        formReset() {
          this.form = { id: '', name: '', markup_pct: 0 };
        },

        async saveCompany() {
          const url = '/.netlify/functions/companies';
          const opts = {
            method: this.form.id ? 'PATCH' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(this.form)
          };
          const r = await fetch(url, opts);
          if (r.ok) {
            this.formReset();
            this.loadCompanies();
          } else {
            alert(await r.text());
          }
        },

        async previewMarkup() {
          const r = await fetch('/.netlify/functions/preview-markup', { method: 'POST' });
          this.preview = await r.json();
        },

        async loadLogs() {
          const r = await fetch('/.netlify/functions/logs');
          this.logs = await r.json();
        }
      }
    }
  </script>

  <!-- Bootstrap JS Bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-qm4z+1fQYsrMJDQ7q3u+u9E+eF+jAE+amYHegQ6UnATrZD+YWHa0G+FxP0iQYzR8"
    crossorigin="anonymous"
  ></script>
</body>
</html>
