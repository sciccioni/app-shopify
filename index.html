<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ðŸ”„ Inventory Sync</title>

  <!-- Bootswatch Lux Theme -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootswatch@5/dist/lux/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />
  <!-- Alpine.js -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <style>
    body { padding-top: 70px; background-color: #f8f9fa; }
    section { display: none; }
    section.active { display: block; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-arrow-repeat"></i> Inventory Sync
      </a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navMenu"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a
              class="nav-link"
              :class="{ active: tab==='upload' }"
              @click.prevent="tab='upload'"
              href="#"
            ><i class="bi bi-upload"></i> Importa</a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              :class="{ active: tab==='review' }"
              @click.prevent="tab='review'"
              href="#"
            ><i class="bi bi-journal-check"></i> Revisione</a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              :class="{ active: tab==='markup' }"
              @click.prevent="tab='markup'"
              href="#"
            ><i class="bi bi-percent"></i> Markup</a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              :class="{ active: tab==='logs' }"
              @click.prevent="tab='logs'"
              href="#"
            ><i class="bi bi-clock-history"></i> Log</a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              :class="{ active: tab==='data' }"
              @click.prevent="tab='data'; loadStaging(); loadNormalized()"
              href="#"
            ><i class="bi bi-table"></i> Dati</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Container principale con Alpine -->
  <div class="container mt-4" x-data="app()" x-init="init()">

    <!-- IMPORTA -->
    <section :class="{ 'active': tab==='upload' }" class="mb-5">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-upload"></i> Importa Inventario
        </div>
        <div class="card-body">
          <input type="file" class="form-control mb-3" @change="onFileChange" />
          <button class="btn btn-success" @click="uploadFile()">
            <i class="bi bi-play-circle"></i> Avvia Importazione
          </button>
          <div class="progress mt-3" x-show="uploadProgress !== null">
            <div
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              :style="'width:' + uploadProgress + '%'"
              x-text="uploadProgress + '%'"
            ></div>
          </div>
          <div class="mt-2 text-success fw-bold" x-text="uploadStatus"></div>
        </div>
      </div>
    </section>

    <!-- REVISIONE MODIFICHE -->
    <section :class="{ 'active': tab==='review' }" class="mb-5">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="bi bi-journal-check"></i> Revisione Modifiche</span>
          <button class="btn btn-success" @click="approveSelected()">
            <i class="bi bi-check2-circle"></i> Approv
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th><input type="checkbox" @click="toggleAll($event)" /></th>
                  <th>MINSAN</th>
                  <th>Qty (Old â†’ New)</th>
                  <th>Prezzo (Old â†’ New)</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="u in updates" :key="u.id">
                  <tr>
                    <td><input type="checkbox" x-model="u.sel" /></td>
                    <td x-text="u.minsan"></td>
                    <td x-text="u.old_qty + ' â†’ ' + u.new_qty"></td>
                    <td x-text="u.old_price.toFixed(2) + ' â†’ ' + u.new_price.toFixed(2)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- MARKUP -->
    <section :class="{ 'active': tab==='markup' }" class="mb-5">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-percent"></i> Gestione Markup
        </div>
        <div class="card-body">
          <div class="table-responsive mb-4">
            <table class="table">
              <thead><tr><th>Nome</th><th>Markup (%)</th></tr></thead>
              <tbody>
                <template x-for="c in companies" :key="c.id">
                  <tr>
                    <td x-text="c.name"></td>
                    <td x-text="c.markup_pct.toFixed(2)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <form @submit.prevent="saveCompany" class="row g-3 mb-4">
            <input type="hidden" x-model="form.id" />
            <div class="col-md-5">
              <input class="form-control" x-model="form.name" placeholder="Nome Ditta" required />
            </div>
            <div class="col-md-4">
              <input
                class="form-control"
                type="number"
                x-model="form.markup_pct"
                placeholder="Markup %"
                step="0.01"
                required
              />
            </div>
            <div class="col-md-3 d-flex">
              <button class="btn btn-success me-2">
                <i class="bi bi-save"></i> Salva
              </button>
              <button class="btn btn-secondary" @click="formReset()">
                <i class="bi bi-x-circle"></i> Annulla
              </button>
            </div>
          </form>
          <button class="btn btn-info" @click="previewMarkup()">
            <i class="bi bi-binoculars"></i> Anteprima
          </button>
          <ul class="list-group mt-3">
            <template x-for="p in preview" :key="p.minsan">
              <li class="list-group-item d-flex justify-content-between">
                <span x-text="p.minsan"></span>
                <span x-text="p.old_price.toFixed(2) + ' â†’ ' + p.new_price.toFixed(2)"></span>
              </li>
            </template>
          </ul>
        </div>
      </div>
    </section>

    <!-- LOG -->
    <section :class="{ 'active': tab==='logs' }" class="mb-5">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-clock-history"></i> Log Aggiornamenti
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr><th>Data</th><th>MINSAN</th><th>Azione</th><th>Esito</th></tr>
              </thead>
              <tbody>
                <template x-for="l in logs" :key="l.id">
                  <tr>
                    <td x-text="new Date(l.executed_at).toLocaleString()"></td>
                    <td x-text="l.minsan"></td>
                    <td x-text="l.action"></td>
                    <td>
                      <span
                        class="badge"
                        :class="l.status==='success' ? 'bg-success' : 'bg-danger'"
                        x-text="l.status"
                      ></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- DATI -->
    <section :class="{ 'active': tab==='data' }" class="mb-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-database-fill"></i> Staging Inventory</h3>
        <button class="btn btn-warning" @click="normalizeAndReload()">
          <i class="bi bi-arrow-repeat"></i> Normalizza
        </button>
      </div>
      <div class="card mb-4 shadow-sm">
        <div class="card-body table-responsive">
          <table class="table table-sm table-striped">
            <thead>
              <tr><th>MINSAN</th><th>Batch</th><th>Giacenza</th><th>Scadenza</th></tr>
            </thead>
            <tbody>
              <template x-for="r in staging" :key="r.id">
                <tr>
                  <td x-text="r.minsan"></td>
                  <td x-text="r.batch"></td>
                  <td x-text="r.raw_quantity"></td>
                  <td x-text="r.raw_expiry ? new Date(r.raw_expiry).toLocaleDateString() : '-'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-bounding-box-circles"></i> Normalized Inventory</h3>
        <button class="btn btn-secondary" @click="loadNormalized()">
          <i class="bi bi-arrow-clockwise"></i> Ricarica
        </button>
      </div>
      <div class="card shadow-sm">
        <div class="card-body table-responsive">
          <table class="table table-sm table-striped">
            <thead>
              <tr><th>MINSAN</th><th>Totale Qty</th><th>Expiry</th></tr>
            </thead>
            <tbody>
              <template x-for="n in normalized" :key="n.minsan">
                <tr>
                  <td x-text="n.minsan"></td>
                  <td x-text="n.total_qty"></td>
                  <td x-text="n.expiry ? new Date(n.expiry).toLocaleDateString() : '-'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- Alpine.js App Logic -->
  <script>
    function app() {
      return {
        tab: 'upload',
        importId: '',
        file: null,
        uploadStatus: '',
        uploadProgress: null,
        updates: [],
        companies: [],
        form: { id:'', name:'', markup_pct:0 },
        preview: [],
        logs: [],
        staging: [],
        normalized: [],

        init() {
          if (this.importId) {
            this.loadUpdates();
            this.loadCompanies();
            this.loadLogs();
            this.loadStaging();
            this.loadNormalized();
          } else {
            this.loadCompanies();
            this.loadLogs();
          }
        },

        onFileChange(e) {
          this.file = e.target.files[0];
          this.uploadStatus = '';
          this.uploadProgress = 0;
        },

        uploadFile() {
          if (!this.file) return alert('Seleziona file Excel');
          this.uploadStatus = 'Importazione in corsoâ€¦';
          this.uploadProgress = 0;
          const form = new FormData();
          form.append('file', this.file);
          const xhr = new XMLHttpRequest();
          xhr.open('POST', '/.netlify/functions/upload');

          xhr.upload.addEventListener('progress', e => {
            if (e.lengthComputable) {
              this.uploadProgress = Math.round(e.loaded / e.total * 100);
            }
          });

          xhr.addEventListener('load', async () => {
            if (xhr.status < 300) {
              const { import_id, rows_imported } = JSON.parse(xhr.responseText);
              this.importId = import_id;
              // dopo upload, chiami normalize e compare
              this.uploadStatus = `Importate ${rows_imported} righeâ€¦ Normalizzazione`;
              await fetch('/.netlify/functions/normalize', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ import_id })
              });
              this.uploadStatus = 'Confronto in corsoâ€¦';
              const cmp = await fetch('/.netlify/functions/compare', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ import_id })
              });
              const { updates_count } = await cmp.json();
              this.uploadStatus = `Pronte ${updates_count} modifiche`;
              // ricarica tutte le viste
              this.loadUpdates();
              this.loadStagesAndNormalized();
              this.loadCompanies();
              this.loadLogs();
            } else {
              this.uploadStatus = `Errore upload: ${xhr.responseText}`;
            }
          });

          xhr.addEventListener('error', () => {
            this.uploadStatus = 'Errore di rete durante l\'upload';
          });

          xhr.send(form);
        },

        async loadUpdates() {
          if (!this.importId) return;
          const r = await fetch(`/.netlify/functions/list-updates?import_id=${this.importId}`);
          this.updates = (await r.json()).map(u => ({ ...u, sel: false }));
        },
        toggleAll(e) {
          this.updates.forEach(u => u.sel = e.target.checked);
        },
        async approveSelected() {
          const ids = this.updates.filter(u => u.sel).map(u => u.id);
          if (!ids.length) return alert('Seleziona almeno una modifica');
          await fetch('/.netlify/functions/approve', {
            method:'POST',
            body: JSON.stringify({ update_ids: ids })
          });
          this.loadUpdates();
          this.loadLogs();
        },

        async loadCompanies() {
          const r = await fetch('/.netlify/functions/companies');
          this.companies = await r.json();
        },
        formReset() {
          this.form = { id:'', name:'', markup_pct:0 };
        },
        async saveCompany() {
          const opts = {
            method: this.form.id ? 'PATCH' : 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(this.form)
          };
          await fetch('/.netlify/functions/companies', opts);
          this.formReset();
          this.loadCompanies();
        },
        async previewMarkup() {
          const r = await fetch('/.netlify/functions/preview-markup',{method:'POST'});
          this.preview = await r.json();
        },
        async loadLogs() {
          const r = await fetch('/.netlify/functions/logs');
          this.logs = await r.json();
        },

        async loadStaging() {
          if (!this.importId) return;
          const r = await fetch(`/.netlify/functions/get-staging?import_id=${this.importId}`);
          this.staging = await r.json();
        },
        async loadNormalized() {
          if (!this.importId) return;
          const r = await fetch(`/.netlify/functions/get-normalized?import_id=${this.importId}`);
          this.normalized = await r.json();
        },
        async normalizeAndReload() {
          if (!this.importId) return alert('Prima importa un file');
          await fetch('/.netlify/functions/normalize', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ import_id: this.importId })
          });
          this.loadStaging();
          this.loadNormalized();
        },
        // helper che carica insieme staging e normalized
        async loadStagesAndNormalized() {
          await this.loadStaging();
          await this.loadNormalized();
        }
      }
    }
  </script>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
