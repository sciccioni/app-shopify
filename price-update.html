<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Prezzi Shopify</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .drop-zone.drag-over {
            background-color: #e2e8f0;
            border-color: #94a3b8;
        }
        .loader {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .price-input {
            width: 100px;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .price-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.25);
            outline: none;
        }
        .price-input.changed {
            background-color: #fef9c3; /* yellow-100 */
            border-color: #facc15; /* yellow-400 */
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25em 0.6em;
            font-size: 0.85em;
            font-weight: 500;
            border-radius: 9999px;
        }
        .status-ok { background-color: #dcfce7; color: #166534; }
        .status-not-found { background-color: #feefc7; color: #92400e; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        .status-to-update { background-color: #dbeafe; color: #1e40af; }
        .status-synced { background-color: #c7d2fe; color: #3730a3; }
        .status-duplicate { background-color: #fef9c3; color: #92400e; }

        .summary-card {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .summary-card .value {
            font-size: 1.875rem;
            font-weight: 700;
        }
        .summary-card .label {
            font-size: 0.875rem;
            color: #4b5563;
        }
        .filter-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .filter-button.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-button.active {
            color: #4f46e5; /* indigo-600 */
            border-bottom-color: #4f46e5;
            font-weight: 600;
        }
        #progress-bar {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="password-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-center">Accesso Richiesto</h2>
            <p class="text-center text-gray-600 mb-6">Inserisci la password per utilizzare l'applicazione.</p>
            <div class="space-y-4">
                <div>
                    <label for="password-input" class="sr-only">Password</label>
                    <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Password">
                </div>
                <button id="login-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Accedi</button>
            </div>
            <p id="password-error" class="text-red-500 text-sm text-center mt-4 hidden">Password non corretta. Riprova.</p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-full">
            <header class="mb-4">
                <h1 class="text-3xl font-bold text-gray-900">App Gestione Prezzi</h1>
                <p class="text-gray-600 mt-1">Carica un file per analizzare, modificare e verificare i dati dei prodotti.</p>
            </header>

            <div class="border-b border-gray-200 mb-6">
                <nav class="flex -mb-px">
                    <button id="pricing-tab-button" class="tab-button active">Gestione Prezzi</button>
                    <button id="verify-tab-button" class="tab-button">Verifica File</button>
                </nav>
            </div>

            <div id="pricing-content">
                <main class="space-y-6">
                    <!-- Sezione di Upload -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4">1. Carica il File Giacenze</h2>
                        <div id="drop-zone" class="drop-zone p-8 text-center rounded-lg cursor-pointer">
                            <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls, .csv">
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-file-arrow-up text-4xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600">Trascina qui il file o <span class="font-semibold text-indigo-600">clicca per selezionarlo</span>.</p>
                                <p id="file-name" class="text-sm text-gray-500 mt-2"></p>
                            </div>
                        </div>
                        <button id="analyze-button" class="mt-4 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed transition-colors" disabled>
                            <i class="fa-solid fa-magnifying-glass-chart mr-2"></i>Analizza e Carica Dati Shopify
                        </button>
                    </div>

                    <!-- Sezione Risultati e Filtri -->
                    <div id="results-section" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hidden">
                        <h2 class="text-xl font-semibold mb-4">2. Risultati e Modifica Prezzi</h2>
                        
                        <!-- Messaggi e Loader -->
                        <div id="loader" class="text-center p-8 hidden">
                            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
                            <p id="loader-text" class="mt-4 text-gray-600">Elaborazione in corso...</p>
                        </div>
                        <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-4 mb-4 hidden">
                            <div id="progress-bar" class="bg-indigo-600 h-4 rounded-full text-center text-white text-xs leading-4" style="width: 0%">0%</div>
                        </div>
                        <div id="error-message-box" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md hidden mb-4" role="alert">
                           <p id="error-message-text" class="text-sm"></p>
                        </div>
                        <div id="sync-status-message" class="text-center font-semibold hidden mb-4 p-4 rounded-md"></div>

                        <!-- Summary Section -->
                        <div id="summary-section" class="hidden grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6"></div>

                        <!-- Controlli e Filtri -->
                        <div id="controls-container" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="search" id="search-ditta" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Filtra per Ditta...">
                                <input type="search" id="search-ean" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Filtra per EAN/Minsan...">
                                <input type="search" id="search-desc" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Filtra per Descrizione...">
                            </div>
                            
                            <div id="filter-buttons" class="flex flex-wrap gap-2 mb-4 border-b pb-4"></div>

                            <!-- Sezione Ricarico -->
                            <div class="flex items-center gap-4 mt-4 p-4 bg-gray-100 rounded-lg border border-gray-200">
                                <label for="markup-percentage" class="text-sm font-medium whitespace-nowrap">Applica Ricarico (%):</label>
                                <input type="number" id="markup-percentage" class="w-24 px-2 py-1 border border-gray-300 rounded-lg" placeholder="Es. 20">
                                <button id="apply-markup-button" class="bg-blue-600 text-white font-bold py-1 px-4 rounded-lg hover:bg-blue-700 text-sm">
                                    <i class="fa-solid fa-calculator mr-2"></i>Applica ai Selezionati
                                </button>
                            </div>


                            <!-- Azioni di Sincronizzazione -->
                            <div id="sync-action-area" class="mt-6 p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                                    <div class="flex items-center">
                                        <input id="confirm-sync-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                        <label for="confirm-sync-checkbox" class="ml-2 block text-sm text-gray-900">
                                            Confermo di voler aggiornare i prezzi per i prodotti selezionati.
                                        </label>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span id="update-count" class="text-sm font-semibold text-indigo-700"></span>
                                        <button id="sync-button" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed transition-colors">
                                            <i class="fa-solid fa-sync-alt mr-2"></i>Sincronizza Prezzi
                                        </button>
                                        <button id="download-csv-button" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 text-sm">
                                            <i class="fa-solid fa-file-csv mr-2"></i>Esporta
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabella Risultati -->
                        <div id="table-container" class="hidden mt-6 overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead id="results-table-head" class="bg-gray-50"></thead>
                                <tbody id="results-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <p id="no-results" class="text-center text-gray-500 mt-8 hidden">Nessun risultato corrisponde ai filtri impostati.</p>
                    </div>
                </main>
            </div>

            <div id="verify-content" class="hidden">
                <main class="space-y-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div id="verify-placeholder">
                            <h2 class="text-xl font-semibold mb-2">Verifica Contenuto File</h2>
                            <p class="text-gray-600">Carica un file nella scheda "Gestione Prezzi" per attivare la ricerca qui.</p>
                        </div>
                        <div id="verify-controls" class="hidden">
                             <h2 class="text-xl font-semibold mb-4">Cerca nel File Caricato</h2>
                            <div class="flex gap-4">
                                <input type="search" id="search-input-verify" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Scrivi qui per cercare in qualsiasi colonna...">
                            </div>
                            <div id="verify-table-container" class="mt-6 overflow-x-auto">
                               <table class="min-w-full divide-y divide-gray-200">
                                   <thead id="verify-table-head" class="bg-gray-50"></thead>
                                   <tbody id="verify-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                               </table>
                               <p id="verify-no-results" class="text-center text-gray-500 mt-4 hidden">Nessun risultato trovato.</p>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        // --- ELEMENTI DEL DOM ---
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const passwordError = document.getElementById('password-error');
        const appContainer = document.getElementById('app-container');

        const pricingTabButton = document.getElementById('pricing-tab-button');
        const verifyTabButton = document.getElementById('verify-tab-button');
        const pricingContent = document.getElementById('pricing-content');
        const verifyContent = document.getElementById('verify-content');

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const analyzeButton = document.getElementById('analyze-button');
        const resultsSection = document.getElementById('results-section');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const errorMessageBox = document.getElementById('error-message-box');
        const errorMessageText = document.getElementById('error-message-text');
        const controlsContainer = document.getElementById('controls-container');
        const tableContainer = document.getElementById('table-container');
        const resultsTableHead = document.getElementById('results-table-head');
        const resultsTableBody = document.getElementById('results-table-body');
        const noResults = document.getElementById('no-results');
        
        const summarySection = document.getElementById('summary-section');
        const filterButtonsContainer = document.getElementById('filter-buttons');

        const searchDitta = document.getElementById('search-ditta');
        const searchEan = document.getElementById('search-ean');
        const searchDesc = document.getElementById('search-desc');

        const markupPercentageInput = document.getElementById('markup-percentage');
        const applyMarkupButton = document.getElementById('apply-markup-button');

        const syncActionArea = document.getElementById('sync-action-area');
        const confirmSyncCheckbox = document.getElementById('confirm-sync-checkbox');
        const syncButton = document.getElementById('sync-button');
        const syncStatusMessage = document.getElementById('sync-status-message');
        const updateCount = document.getElementById('update-count');
        const downloadCsvButton = document.getElementById('download-csv-button');

        // Verification Tab Elements
        const verifyPlaceholder = document.getElementById('verify-placeholder');
        const verifyControls = document.getElementById('verify-controls');
        const searchInputVerify = document.getElementById('search-input-verify');
        const verifyTableHead = document.getElementById('verify-table-head');
        const verifyTableBody = document.getElementById('verify-table-body');
        const verifyNoResults = document.getElementById('verify-no-results');


        // --- STATO DELL'APPLICAZIONE ---
        let userPassword = '';
        let fileDataRaw = [];
        let uniqueProductsForAnalysis = [];
        let duplicateRows = [];
        let combinedData = [];
        let activeFilter = 'all';

        // --- GESTIONE LOGIN ---
        function handleLogin() {
            userPassword = passwordInput.value;
            if (!userPassword) {
                passwordError.textContent = 'La password non può essere vuota.';
                passwordError.classList.remove('hidden');
                return;
            }
            passwordOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }
        loginButton.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });


        // --- GESTIONE SCHEDE (TABS) ---
        pricingTabButton.addEventListener('click', () => {
            pricingTabButton.classList.add('active');
            verifyTabButton.classList.remove('active');
            pricingContent.classList.remove('hidden');
            verifyContent.classList.add('hidden');
        });

        verifyTabButton.addEventListener('click', () => {
            verifyTabButton.classList.add('active');
            pricingTabButton.classList.remove('active');
            verifyContent.classList.remove('hidden');
            pricingContent.classList.add('hidden');
        });

        // --- GESTIONE UPLOAD FILE ---
        function handleFile(file) {
            fileNameDisplay.textContent = file.name;
            analyzeButton.disabled = false;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                fileDataRaw = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                window.dispatchEvent(new CustomEvent('data-loaded-for-verification', { detail: fileDataRaw }));
            };
            reader.readAsArrayBuffer(file);
        }

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        // --- FUNZIONI DI UTILITY ---
        function showLoader(message) {
            loaderText.textContent = message;
            loader.classList.remove('hidden');
        }

        function hideLoader() {
            loader.classList.add('hidden');
        }

        function showMessage(element, message, isError = true) {
            element.innerHTML = message;
            element.className = 'text-center font-semibold p-4 rounded-md';
            if (isError) {
                element.classList.add('bg-red-100', 'text-red-700');
            } else {
                element.classList.add('bg-green-100', 'text-green-700');
            }
            element.classList.remove('hidden');
        }

        function hideMessage(element) {
            element.classList.add('hidden');
        }

        function getValue(obj, keys, defaultValue = '') {
            if (!obj) return defaultValue;
            for (const key of keys) {
                if (obj[key] !== undefined && obj[key] !== null && obj[key] !== '') {
                    return obj[key];
                }
            }
            const lowerCaseKeys = keys.map(k => String(k).toLowerCase());
            for (const objKey in obj) {
                if (lowerCaseKeys.includes(String(objKey).toLowerCase())) {
                     const value = obj[objKey];
                     if (value !== undefined && value !== null && value !== '') {
                        return value;
                     }
                }
            }
            return defaultValue;
        }

        // --- CHIAMATA AL BACKEND ---
        async function callBackend(payload) {
            const endpoint = '/.netlify/functions/shopify-proxy';
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...payload, password: userPassword })
            });

            if (response.status === 401) {
                passwordError.textContent = 'Password non corretta o sessione scaduta.';
                passwordOverlay.classList.remove('hidden');
                appContainer.classList.add('hidden');
                throw new Error("Autenticazione fallita.");
            }

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Errore server: ${response.status}`);
            }

            return await response.json();
        }


        // --- LOGICA PRINCIPALE (GESTIONE PREZZI) ---
        analyzeButton.addEventListener('click', async () => {
            if (fileDataRaw.length === 0) {
                showMessage(errorMessageText, "Nessun dato valido trovato nel file.", true);
                return;
            }
            
            resultsSection.classList.remove('hidden');
            hideMessage(syncStatusMessage);
            hideMessage(errorMessageText);
            controlsContainer.classList.add('hidden');
            tableContainer.classList.add('hidden');
            summarySection.classList.add('hidden');
            
            const skuMap = new Map();
            fileDataRaw.forEach(row => {
                const sku = String(getValue(row, ['EAN', 'Minsan']) || '').trim();
                if (sku) {
                    if (!skuMap.has(sku)) skuMap.set(sku, []);
                    skuMap.get(sku).push(row);
                }
            });

            uniqueProductsForAnalysis = [];
            duplicateRows = [];
            skuMap.forEach((rows, sku) => {
                uniqueProductsForAnalysis.push(rows[0]);
                if (rows.length > 1) {
                    duplicateRows.push(...rows);
                }
            });

            try {
                const allSkus = uniqueProductsForAnalysis.map(row => getValue(row, ['EAN', 'Minsan'])).filter(Boolean).map(String);
                if (allSkus.length === 0) throw new Error("Nessun EAN/Minsan valido trovato nel file.");

                // --- LOGICA A PACCHETTI (CHUNKING) ---
                const chunkSize = 200;
                const skuChunks = [];
                for (let i = 0; i < allSkus.length; i += chunkSize) {
                    skuChunks.push(allSkus.slice(i, i + chunkSize));
                }

                let allShopifyProducts = [];
                progressBarContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';

                for (let i = 0; i < skuChunks.length; i++) {
                    const chunk = skuChunks[i];
                    showLoader(`Analisi pacchetto ${i + 1} di ${skuChunks.length}...`);
                    
                    const shopifyProductsChunk = await callBackend({ type: 'analyze', skus: chunk });
                    allShopifyProducts.push(...shopifyProductsChunk);

                    const percentage = Math.round(((i + 1) / skuChunks.length) * 100);
                    progressBar.style.width = `${percentage}%`;
                    progressBar.textContent = `${percentage}%`;

                    if (skuChunks.length > 1) {
                        await new Promise(resolve => setTimeout(resolve, 250));
                    }
                }
                
                combinedData = uniqueProductsForAnalysis.map(fileRow => {
                    const sku = getValue(fileRow, ['EAN', 'Minsan']);
                    const shopifyProduct = allShopifyProducts.find(p => p.minsan === sku);
                    const isDuplicate = skuMap.get(sku) ? skuMap.get(sku).length > 1 : false;

                    const priceString = String(getValue(fileRow, ['Prezzo', 'Listino', 'Costo', 'CostoMedio'], '0'));
                    const cleanedPriceString = priceString.replace(',', '.').replace(/[^0-9.]/g, '');
                    const priceValue = parseFloat(cleanedPriceString) || 0;

                    const baseData = {
                        ditta: getValue(fileRow, ['Ditta']),
                        ean: sku,
                        descrizione: getValue(fileRow, ['Descrizione']),
                        prezzoFile: priceValue,
                        selected: false,
                        newPrice: null,
                        isDuplicate: isDuplicate
                    };

                    if (shopifyProduct && shopifyProduct.found) {
                        return {
                            ...baseData,
                            status: 'ok',
                            shopifyTitle: shopifyProduct.title,
                            shopifyPrice: parseFloat(shopifyProduct.price),
                            productId: shopifyProduct.product_id,
                            variantId: shopifyProduct.variant_id,
                        };
                    } else {
                        return {
                            ...baseData,
                            status: 'not-found',
                            shopifyTitle: 'N/D',
                            shopifyPrice: 'N/D'
                        };
                    }
                });

                updateSummary();
                renderFilterButtons();
                renderTable();
                controlsContainer.classList.remove('hidden');
                tableContainer.classList.remove('hidden');
                summarySection.style.display = 'grid';

            } catch (error) {
                console.error("Errore durante l'analisi:", error);
                showMessage(errorMessageText, `<b>Errore:</b> ${error.message}`, true);
            } finally {
                hideLoader();
                progressBarContainer.classList.add('hidden');
            }
        });

        function updateSummary() {
            const stats = {
                totalRows: fileDataRaw.length,
                uniqueProducts: uniqueProductsForAnalysis.length,
                duplicates: duplicateRows.length,
                toUpdate: combinedData.filter(item => item.newPrice !== null).length,
                notFound: combinedData.filter(item => item.status === 'not-found').length,
                synced: combinedData.filter(item => item.status === 'synced').length
            };

            summarySection.innerHTML = `
                <div class="summary-card"><div class="value">${stats.totalRows}</div><div class="label">Righe Totali</div></div>
                <div class="summary-card"><div class="value text-blue-600">${stats.uniqueProducts}</div><div class="label">Prodotti Unici</div></div>
                <div class="summary-card"><div class="value text-yellow-600">${stats.duplicates}</div><div class="label">Righe Duplicate</div></div>
                <div class="summary-card"><div class="value text-purple-600">${stats.toUpdate}</div><div class="label">Da Aggiornare</div></div>
                <div class="summary-card"><div class="value text-orange-600">${stats.notFound}</div><div class="label">Non Trovati</div></div>
                <div class="summary-card"><div class="value text-green-600">${stats.synced}</div><div class="label">Aggiornati</div></div>
            `;
        }

        function renderFilterButtons() {
            const filters = [
                { id: 'all', label: 'Tutti' },
                { id: 'to-update', label: 'Da Aggiornare' },
                { id: 'not-found', label: 'Non Trovati' },
                { id: 'duplicates', label: 'Duplicati' }
            ];

            if (combinedData.some(item => item.status === 'synced')) {
                filters.push({ id: 'synced', label: 'Aggiornati' });
            }

            filterButtonsContainer.innerHTML = filters.map(f => `
                <button class="filter-button ${activeFilter === f.id ? 'active' : ''}" data-filter="${f.id}">
                    ${f.label}
                </button>
            `).join('');
        }
        
        function getCurrentlyFilteredData() {
            const dittaFilter = searchDitta.value.toLowerCase();
            const eanFilter = searchEan.value.toLowerCase();
            const descFilter = searchDesc.value.toLowerCase();

            let dataToDisplay;
            if (activeFilter === 'duplicates') {
                dataToDisplay = duplicateRows;
            } else {
                dataToDisplay = combinedData.filter(item => {
                    const statusMatch = activeFilter === 'all' || item.status === activeFilter || (activeFilter === 'to-update' && item.newPrice !== null);
                    return statusMatch;
                });
            }

            return dataToDisplay.filter(item => {
                 const ditta = getValue(item, ['Ditta']);
                 const ean = getValue(item, ['EAN', 'Minsan']);
                 const desc = getValue(item, ['Descrizione']);
                 return ditta.toLowerCase().includes(dittaFilter) &&
                        ean.toLowerCase().includes(eanFilter) &&
                        desc.toLowerCase().includes(descFilter);
            });
        }


        function renderTable() {
            updateSummary();
            const filteredData = getCurrentlyFilteredData();
            const isDuplicateView = activeFilter === 'duplicates';

            resultsTableHead.innerHTML = '';
            resultsTableBody.innerHTML = '';
            noResults.classList.toggle('hidden', filteredData.length > 0);

            if (filteredData.length > 0) {
                if (isDuplicateView) {
                    const headers = ['Ditta', 'EAN/Minsan', 'Descrizione', 'Prezzo File'];
                    resultsTableHead.innerHTML = `<tr>${headers.map(h => `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
                    filteredData.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'bg-yellow-50';
                        row.innerHTML = `
                            <td class="px-3 py-4 text-sm">${getValue(item, ['Ditta'])}</td>
                            <td class="px-3 py-4 text-sm font-semibold">${getValue(item, ['EAN', 'Minsan'])}</td>
                            <td class="px-3 py-4 text-sm">${getValue(item, ['Descrizione'])}</td>
                            <td class="px-3 py-4 text-sm font-mono">${(parseFloat(getValue(item, ['Prezzo', 'Listino', 'Costo', 'CostoMedio'], '0').toString().replace(',', '.')) || 0).toFixed(2)} €</td>
                        `;
                        resultsTableBody.appendChild(row);
                    });
                } else {
                    const headers = ['<input type="checkbox" id="select-all-checkbox">', 'Ditta', 'EAN/Minsan', 'Descrizione File', 'Prezzo File', 'Stato', 'Titolo Shopify', 'Prezzo Shopify', 'Nuovo Prezzo'];
                    resultsTableHead.innerHTML = `<tr>${headers.map(h => `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
                    filteredData.forEach(item => {
                        const row = document.createElement('tr');
                        row.dataset.ean = item.ean;
                        const statusInfo = getStatusInfo(item);
                        row.innerHTML = `
                            <td class="px-3 py-4"><input type="checkbox" class="row-checkbox" ${item.selected ? 'checked' : ''} ${item.status === 'not-found' ? 'disabled' : ''}></td>
                            <td class="px-3 py-4 text-sm">${item.ditta}</td>
                            <td class="px-3 py-4 text-sm font-semibold">${item.ean} ${item.isDuplicate ? '<i class="fa-solid fa-copy text-yellow-500 ml-1" title="Questo EAN è duplicato nel file originale"></i>' : ''}</td>
                            <td class="px-3 py-4 text-sm">${item.descrizione}</td>
                            <td class="px-3 py-4 text-sm font-mono">${item.prezzoFile.toFixed(2)} €</td>
                            <td class="px-3 py-4 text-sm"><span class="${statusInfo.badgeClass}">${statusInfo.icon} ${statusInfo.label}</span></td>
                            <td class="px-3 py-4 text-sm">${item.shopifyTitle}</td>
                            <td class="px-3 py-4 text-sm font-mono">${typeof item.shopifyPrice === 'number' ? item.shopifyPrice.toFixed(2) + ' €' : 'N/D'}</td>
                            <td class="px-3 py-4">
                                <input type="number" step="0.01" class="price-input ${item.newPrice !== null ? 'changed' : ''}" placeholder="Nuovo Prezzo" value="${item.newPrice !== null ? item.newPrice.toFixed(2) : ''}" ${item.status === 'not-found' ? 'disabled' : ''}>
                            </td>
                        `;
                        resultsTableBody.appendChild(row);
                    });
                }
            }
            updateSyncArea();
        }

        function getStatusInfo(item) {
            if (item.status === 'synced') return { label: 'Aggiornato', badgeClass: 'status-badge status-synced', icon: '<i class="fa-solid fa-check-double mr-1"></i>' };
            if (item.newPrice !== null) return { label: 'Da Aggiornare', badgeClass: 'status-badge status-to-update', icon: '<i class="fa-solid fa-upload mr-1"></i>' };
            switch (item.status) {
                case 'ok': return { label: 'Trovato', badgeClass: 'status-badge status-ok', icon: '<i class="fa-solid fa-check-circle mr-1"></i>' };
                case 'not-found': return { label: 'Non Trovato', badgeClass: 'status-badge status-not-found', icon: '<i class="fa-solid fa-question-circle mr-1"></i>' };
                default: return { label: 'Errore', badgeClass: 'status-badge status-error', icon: '<i class="fa-solid fa-exclamation-triangle mr-1"></i>' };
            }
        }

        [searchDitta, searchEan, searchDesc].forEach(el => el.addEventListener('input', renderTable));
        
        filterButtonsContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                activeFilter = e.target.dataset.filter;
                renderFilterButtons();
                renderTable();
            }
        });

        resultsTableBody.addEventListener('change', (e) => {
            const target = e.target;
            const row = target.closest('tr');
            if (!row) return;
            const ean = row.dataset.ean;
            const item = combinedData.find(d => d.ean === ean);
            if (!item) return;

            if (target.classList.contains('row-checkbox')) {
                item.selected = target.checked;
            }
            if (target.classList.contains('price-input')) {
                const newPriceValue = target.value.trim();
                item.newPrice = newPriceValue === '' ? null : parseFloat(newPriceValue);
                target.classList.toggle('changed', item.newPrice !== null);
                updateSummary();
                const statusCell = row.children[5].firstElementChild;
                const statusInfo = getStatusInfo(item);
                statusCell.className = statusInfo.badgeClass;
                statusCell.innerHTML = `${statusInfo.icon} ${statusInfo.label}`;
            }
            updateSyncArea();
        });

        resultsTableHead.addEventListener('change', (e) => {
            if (e.target.id === 'select-all-checkbox') {
                const isChecked = e.target.checked;
                const currentlyFilteredData = getCurrentlyFilteredData();
                currentlyFilteredData.forEach(item => {
                    if (item.status !== 'not-found') {
                        const originalItem = combinedData.find(d => d.ean === item.ean);
                        if (originalItem) {
                           originalItem.selected = isChecked;
                        }
                    }
                });
                renderTable(); 
            }
        });
        
        function updateSyncArea() {
            const itemsToUpdate = combinedData.filter(item => item.selected && item.newPrice !== null && item.status !== 'not-found');
            const count = itemsToUpdate.length;
            
            updateCount.textContent = `${count} prodotti pronti per la sincronizzazione`;
            syncButton.disabled = count === 0 || !confirmSyncCheckbox.checked;
            confirmSyncCheckbox.disabled = count === 0;
        }

        confirmSyncCheckbox.addEventListener('change', updateSyncArea);

        applyMarkupButton.addEventListener('click', () => {
            const percentage = parseFloat(markupPercentageInput.value);
            if (isNaN(percentage)) {
                showMessage(errorMessageText, "Per favore, inserisci una percentuale di ricarico valida.", true);
                setTimeout(() => hideMessage(errorMessageText), 3000);
                return;
            }

            const selectedItems = combinedData.filter(item => item.selected && item.status !== 'not-found');
            if (selectedItems.length === 0) {
                showMessage(errorMessageText, "Nessun prodotto selezionato a cui applicare il ricarico.", true);
                setTimeout(() => hideMessage(errorMessageText), 3000);
                return;
            }
            
            selectedItems.forEach(item => {
                const basePrice = item.prezzoFile;
                if (typeof basePrice === 'number') {
                    const newPrice = basePrice * (1 + percentage / 100);
                    item.newPrice = parseFloat(newPrice.toFixed(2));
                }
            });

            renderTable();
        });

        syncButton.addEventListener('click', async () => {
            const itemsToSync = combinedData.filter(item => item.selected && item.newPrice !== null && item.status !== 'not-found');
            if (itemsToSync.length === 0) {
                showMessage(syncStatusMessage, "Nessun prodotto valido selezionato per la sincronizzazione.", true);
                return;
            }

            hideMessage(syncStatusMessage);
            syncButton.disabled = true;
            confirmSyncCheckbox.disabled = true;

            try {
                // --- LOGICA A PACCHETTI (CHUNKING) PER LA SINCRONIZZAZIONE ---
                const chunkSize = 50;
                const itemChunks = [];
                for (let i = 0; i < itemsToSync.length; i += chunkSize) {
                    itemChunks.push(itemsToSync.slice(i, i + chunkSize));
                }

                progressBarContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';

                for (let i = 0; i < itemChunks.length; i++) {
                    const chunk = itemChunks[i];
                    showLoader(`Sincronizzazione pacchetto ${i + 1} di ${itemChunks.length}...`);

                    const payload = {
                        type: 'sync',
                        items: chunk.map(item => ({
                            variantId: item.variantId,
                            price: item.newPrice
                        }))
                    };
                    await callBackend(payload);
                    
                    // Aggiorna lo stato degli item nel chunk dopo il successo
                    chunk.forEach(syncedItem => {
                        const originalItem = combinedData.find(d => d.ean === syncedItem.ean);
                        originalItem.shopifyPrice = syncedItem.newPrice;
                        originalItem.newPrice = null;
                        originalItem.selected = false;
                        originalItem.status = 'synced';
                    });

                    const percentage = Math.round(((i + 1) / itemChunks.length) * 100);
                    progressBar.style.width = `${percentage}%`;
                    progressBar.textContent = `${percentage}%`;

                    if (itemChunks.length > 1) {
                        await new Promise(resolve => setTimeout(resolve, 250));
                    }
                }
                
                showMessage(syncStatusMessage, `Sincronizzazione completata con successo per ${itemsToSync.length} prodotti!`, false);
                confirmSyncCheckbox.checked = false;
                renderFilterButtons();
                renderTable();

            } catch (error) {
                console.error("Errore di sincronizzazione:", error);
                showMessage(syncStatusMessage, `<b>Errore durante la sincronizzazione:</b> ${error.message}`, true);
            } finally {
                hideLoader();
                progressBarContainer.classList.add('hidden');
                updateSyncArea();
            }
        });
        
        downloadCsvButton.addEventListener('click', () => {
            const dataToExport = combinedData.map(item => ({
                Ditta: item.ditta,
                EAN: item.ean,
                Descrizione: `"${item.descrizione.replace(/"/g, '""')}"`,
                'Prezzo File': item.prezzoFile.toFixed(2),
                Stato: getStatusInfo(item).label,
                'Titolo Shopify': `"${(item.shopifyTitle || '').replace(/"/g, '""')}"`,
                'Prezzo Shopify': typeof item.shopifyPrice === 'number' ? item.shopifyPrice.toFixed(2) : 'N/D',
                'Nuovo Prezzo Proposto': item.newPrice !== null ? item.newPrice.toFixed(2) : ''
            }));

            if (dataToExport.length === 0) return;

            const headers = Object.keys(dataToExport[0]);
            const csvRows = [headers.join(';')];

            for (const row of dataToExport) {
                csvRows.push(Object.values(row).join(';'));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'report_prezzi.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- LOGICA VERIFICA FILE ---
        window.addEventListener('data-loaded-for-verification', (event) => {
            verifyPlaceholder.classList.add('hidden');
            verifyControls.classList.remove('hidden');
            renderVerificationTable(event.detail);
        });
        
        function renderVerificationTable(data) {
            verifyTableHead.innerHTML = '';
            verifyTableBody.innerHTML = '';
            verifyNoResults.classList.toggle('hidden', data.length > 0);

            if (data.length > 0) {
                const headers = Object.keys(data[0]);
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.className = "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                verifyTableHead.appendChild(headerRow);

                data.forEach(item => {
                    const row = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.className = "px-3 py-4 whitespace-nowrap text-sm text-gray-700";
                        td.textContent = item[header] ?? '';
                        row.appendChild(td);
                    });
                    verifyTableBody.appendChild(row);
                });
            }
        }

        function performSearch() {
            const searchTerm = searchInputVerify.value.toLowerCase();
            if (!searchTerm) {
                renderVerificationTable(fileDataRaw);
                return;
            }
            const filteredData = fileDataRaw.filter(item => 
                Object.values(item).some(val => 
                    String(val).toLowerCase().includes(searchTerm)
                )
            );
            renderVerificationTable(filteredData);
        }

        searchInputVerify.addEventListener('input', performSearch);


    </script>
</body>
</html>
